{"version":3,"sources":["../../../../../../packages/core/src/database/queries.ts","../../../../../../apps/matte/src/components/app/jobs/job-detail-view.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/matte/src/app/app/jobs/%5Bid%5D/page.tsx"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"../types/database\";\n\n/**\n * Get all team members for a company\n */\nexport async function getTeamMembers(\n  supabase: SupabaseClient<Database>,\n  companyId: string\n) {\n  // Get company users\n  const { data: companyUsers } = await supabase\n    .from(\"company_users\")\n    .select(\"user_id\")\n    .eq(\"company_id\", companyId);\n\n  if (!companyUsers || companyUsers.length === 0) {\n    return [];\n  }\n\n  // Get user profiles\n  const userIds = companyUsers.map((cu) => cu.user_id);\n  const { data: profiles } = await supabase\n    .from(\"user_profiles\")\n    .select(\"id, email, full_name\")\n    .in(\"id\", userIds);\n\n  return (\n    profiles?.map((p) => ({\n      id: p.id,\n      email: p.email,\n      fullName: p.full_name || p.email,\n    })) || []\n  );\n}\n\n/**\n * Get all jobs with their associated customers for a company\n */\nexport async function getJobsWithCustomers(\n  supabase: SupabaseClient<Database>,\n  companyId: string\n) {\n  // Get jobs\n  const { data: jobs } = await supabase\n    .from(\"jobs\")\n    .select(\"*\")\n    .eq(\"company_id\", companyId)\n    .order(\"created_at\", { ascending: false });\n\n  if (!jobs || jobs.length === 0) {\n    return [];\n  }\n\n  // Get unique customer IDs\n  const customerIds = [...new Set(jobs.filter((j) => j.customer_id).map((j) => j.customer_id!))];\n\n  // Get customers\n  const { data: customers } = customerIds.length > 0\n    ? await supabase\n        .from(\"customers\")\n        .select(\"*\")\n        .in(\"id\", customerIds)\n    : { data: [] };\n\n  const customerMap = new Map(customers?.map((c) => [c.id, c]) || []);\n\n  return jobs.map((job) => ({\n    ...job,\n    customer: job.customer_id ? customerMap.get(job.customer_id) || null : null,\n  }));\n}\n\n/**\n * Get all scheduled jobs with their customers for a company\n */\nexport async function getScheduledJobs(\n  supabase: SupabaseClient<Database>,\n  companyId: string\n) {\n  // Get scheduled jobs\n  const { data: jobs } = await supabase\n    .from(\"jobs\")\n    .select(\"*\")\n    .eq(\"company_id\", companyId)\n    .not(\"scheduled_date\", \"is\", null)\n    .order(\"scheduled_date\", { ascending: true });\n\n  if (!jobs || jobs.length === 0) {\n    return [];\n  }\n\n  // Get unique customer IDs\n  const customerIds = [...new Set(jobs.filter((j) => j.customer_id).map((j) => j.customer_id!))];\n\n  // Get customers\n  const { data: customers } = customerIds.length > 0\n    ? await supabase\n        .from(\"customers\")\n        .select(\"*\")\n        .in(\"id\", customerIds)\n    : { data: [] };\n\n  const customerMap = new Map(customers?.map((c) => [c.id, c]) || []);\n\n  return jobs.map((job) => ({\n    ...job,\n    customer: job.customer_id ? customerMap.get(job.customer_id) || null : null,\n  }));\n}\n\n/**\n * Get dashboard data for a company\n * Includes active jobs, outstanding payments, low inventory, and time tracking\n */\nexport async function getDashboardData(\n  supabase: SupabaseClient<Database>,\n  companyId: string\n) {\n  // Fetch all data in parallel\n  const [jobsResult, inventoryResult, timeEntriesResult] = await Promise.all([\n    // Active jobs and outstanding payments\n    supabase\n      .from(\"jobs\")\n      .select(\"id, status, payment_state, payment_amount\")\n      .eq(\"company_id\", companyId),\n\n    // Low inventory items\n    supabase\n      .from(\"inventory_items\")\n      .select(\"id, name, on_hand, reorder_at, unit\")\n      .eq(\"company_id\", companyId),\n\n    // Time entries for today and this week\n    supabase\n      .from(\"time_entries\")\n      .select(\"duration_seconds, started_at\")\n      .eq(\"company_id\", companyId),\n  ]);\n\n  const jobs = jobsResult.data || [];\n  const inventoryItems = inventoryResult.data || [];\n  const timeEntries = timeEntriesResult.data || [];\n\n  // Calculate active jobs count\n  const activeJobs = jobs.filter((j) =>\n    [\"scheduled\", \"in_progress\"].includes(j.status)\n  ).length;\n\n  // Calculate outstanding payments (jobs with payment_state = \"due\")\n  const outstandingPayments = jobs\n    .filter((j) => j.payment_state === \"due\" && j.payment_amount)\n    .reduce((sum, j) => sum + (j.payment_amount || 0), 0);\n\n  // Find low inventory items (on_hand <= reorder_at)\n  const lowInventoryItems = inventoryItems.filter(\n    (item) => item.on_hand <= item.reorder_at && item.reorder_at > 0\n  );\n\n  // Calculate time tracking summary\n  const now = new Date();\n  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  const startOfWeek = new Date(startOfToday);\n  startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay()); // Start of week (Sunday)\n\n  const todayEntries = timeEntries.filter((entry) => {\n    const entryDate = new Date(entry.started_at);\n    return entryDate >= startOfToday && entry.duration_seconds;\n  });\n\n  const weekEntries = timeEntries.filter((entry) => {\n    const entryDate = new Date(entry.started_at);\n    return entryDate >= startOfWeek && entry.duration_seconds;\n  });\n\n  const todayHours = todayEntries.reduce((sum, entry) =>\n    sum + (entry.duration_seconds || 0), 0\n  ) / 3600;\n\n  const weekHours = weekEntries.reduce((sum, entry) =>\n    sum + (entry.duration_seconds || 0), 0\n  ) / 3600;\n\n  return {\n    activeJobs,\n    outstandingPayments,\n    lowInventoryCount: lowInventoryItems.length,\n    lowInventoryItems: lowInventoryItems.slice(0, 5), // Limit to 5 for display\n    todayHours: Math.round(todayHours * 10) / 10, // Round to 1 decimal\n    weekHours: Math.round(weekHours * 10) / 10,\n    hasTimeTracking: timeEntries.length > 0,\n  };\n}\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const JobDetailView = registerClientReference(\n    function() { throw new Error(\"Attempted to call JobDetailView() from the server but JobDetailView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/matte/src/components/app/jobs/job-detail-view.tsx\",\n    \"JobDetailView\",\n);\n","import { notFound } from \"next/navigation\";\nimport { createClient, createAdminClient } from \"@drip/core/database/server\";\nimport { getTeamMembers } from \"@drip/core/database/queries\";\nimport { JobDetailView } from \"@/components/app/jobs/job-detail-view\";\n\nexport default async function JobPage({\n  params,\n}: {\n  params: Promise<{ id: string }>;\n}) {\n  const { id } = await params;\n  const supabase = await createClient();\n  const adminSupabase = createAdminClient();\n\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) return null;\n\n  // Get company ID (use admin client to avoid RLS issues)\n  const { data: companyUser } = await adminSupabase\n    .from(\"company_users\")\n    .select(\"company_id\")\n    .eq(\"user_id\", user.id)\n    .maybeSingle();\n\n  if (!companyUser) return null;\n\n  // Fetch job (use admin client)\n  const { data: job } = await adminSupabase\n    .from(\"jobs\")\n    .select(\"*\")\n    .eq(\"id\", id)\n    .eq(\"company_id\", companyUser.company_id)\n    .maybeSingle();\n\n  if (!job) {\n    notFound();\n  }\n\n  // Fetch customer if exists (use admin client)\n  let customer = null;\n  if (job.customer_id) {\n    const { data } = await adminSupabase\n      .from(\"customers\")\n      .select(\"*\")\n      .eq(\"id\", job.customer_id)\n      .maybeSingle();\n    customer = data;\n  }\n\n  const jobWithCustomer = { ...job, customer };\n\n  // Fetch estimates for this job (use admin client)\n  const { data: estimatesData } = await adminSupabase\n    .from(\"estimates\")\n    .select(\"*\")\n    .eq(\"job_id\", id)\n    .order(\"created_at\", { ascending: false });\n\n  // Fetch line items for estimates (use admin client)\n  const estimates = await Promise.all(\n    (estimatesData || []).map(async (est) => {\n      const { data: lineItems } = await adminSupabase\n        .from(\"estimate_line_items\")\n        .select(\"*\")\n        .eq(\"estimate_id\", est.id);\n      return { ...est, line_items: lineItems || [] };\n    })\n  );\n\n  // Fetch invoices for this job (use admin client)\n  const { data: invoices } = await adminSupabase\n    .from(\"invoices\")\n    .select(\"*\")\n    .eq(\"job_id\", id)\n    .order(\"created_at\", { ascending: false });\n\n  // Fetch materials for this job (use admin client)\n  const { data: materials } = await adminSupabase\n    .from(\"job_materials\")\n    .select(\"*\")\n    .eq(\"job_id\", id)\n    .order(\"created_at\", { ascending: true });\n\n  // Fetch team members (use admin client)\n  const members = await getTeamMembers(adminSupabase, companyUser.company_id);\n\n  // Fetch estimating config\n  const { data: estimatingConfig } = await adminSupabase\n    .from(\"estimating_config\")\n    .select(\"*\")\n    .eq(\"company_id\", companyUser.company_id)\n    .single();\n\n  return (\n    <JobDetailView\n      job={jobWithCustomer}\n      estimates={estimates}\n      invoices={invoices || []}\n      materials={materials || []}\n      teamMembers={members}\n      companyId={companyUser.company_id}\n      estimatingConfig={estimatingConfig}\n    />\n  );\n}\n\n"],"names":[],"mappings":"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","ignoreList":[1]}