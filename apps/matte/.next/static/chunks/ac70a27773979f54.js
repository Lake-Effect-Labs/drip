(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,5449,e=>{"use strict";var t=e.i(43476),s=e.i(71645),a=e.i(18566),r=e.i(26293);e.i(87467);var i=e.i(55654),l=e.i(3116),n=e.i(69638);function o({history:e}){return 0===e.length?(0,t.jsx)("div",{className:"p-4 text-center text-muted-foreground text-sm",children:"No history yet"}):(0,t.jsx)("div",{className:"space-y-4",children:e.map((s,a)=>(0,t.jsxs)("div",{className:"flex gap-4",children:[(0,t.jsxs)("div",{className:"flex flex-col items-center",children:[(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:"done"===s.status||"paid"===s.status?(0,t.jsx)(n.CheckCircle,{className:"h-4 w-4 text-success"}):(0,t.jsx)(l.Clock,{className:"h-4 w-4 text-muted-foreground"})}),a<e.length-1&&(0,t.jsx)("div",{className:"w-0.5 h-full bg-border mt-2"})]}),(0,t.jsxs)("div",{className:"flex-1 pb-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"font-medium",children:i.JOB_STATUS_LABELS[s.status]||s.status}),(0,t.jsxs)("span",{className:"text-sm text-muted-foreground",children:[(0,i.formatDate)(s.changed_at)," ",(0,i.formatTime)(new Date(s.changed_at).toISOString().split("T")[1].split(".")[0])]})]}),s.notes&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-1",children:s.notes})]})]},s.id))})}var d=e.i(7003),c=e.i(40574),m=e.i(34098),u=e.i(80720),h=e.i(63876),x=e.i(524),p=e.i(69481),j=e.i(75254);let g=(0,j.default)("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);var f=e.i(14764),v=e.i(7233),y=e.i(27612),N=e.i(78583),b=e.i(63488);function w({open:e,onOpenChange:a,companyId:l,job:n,customer:o,invoices:j,scheduledDate:w,scheduledTime:_,address:S}){let[k,C]=(0,s.useState)([]),[T,q]=(0,s.useState)(!1),[D,F]=(0,s.useState)(!1),[$,P]=(0,s.useState)(""),[B,E]=(0,s.useState)("sms"),[L,I]=(0,s.useState)(""),[M,O]=(0,s.useState)(""),{addToast:A}=(0,p.useToast)(),H=(0,r.createClient)();async function U(){q(!0);try{let{data:e,error:t}=await H.from("message_templates").select("*").eq("company_id",l).order("created_at",{ascending:!1});if(t)return void C([]);C(e||[])}catch(e){console.error("Error loading templates:",e),A("Failed to load templates","error")}finally{q(!1)}}function z(e){return e.replace(/\{\{customer_name\}\}/g,o?.name||"there").replace(/\{\{job_date\}\}/g,w?(0,i.formatDate)(w):"[date]").replace(/\{\{job_time\}\}/g,_?(0,i.formatTime)(_):"[time]").replace(/\{\{job_address\}\}/g,S||"[address]").replace(/\{\{amount\}\}/g,j[0]?(0,i.formatCurrency)(j[0].amount_total):"[amount]").replace(/\{\{invoice_link\}\}/g,j[0]?`${window.location.origin}/i/${j[0].public_token}`:"[invoice link]")}async function R(){if(!$.trim()||!M.trim())return void A("Please fill in all required fields","error");try{let e,{data:t,error:s}=await H.from("message_templates").insert({company_id:l,name:$.trim(),type:B,subject:"email"===B&&L.trim()?L.trim():null,body:M.trim(),variables:(e=(M+(L||"")).match(/\{\{(\w+)\}\}/g))?[...new Set(e.map(e=>e.replace(/\{\{|\}\}/g,"")))]:[]}).select().single();if(s)throw s;C(e=>[t,...e]),P(""),O(""),I(""),F(!1),A("Template saved!","success")}catch(e){console.error("Error saving template:",e),A("Failed to save template","error")}}async function Q(e){try{let{error:t}=await H.from("message_templates").delete().eq("id",e);if(t)throw t;C(t=>t.filter(t=>t.id!==e)),A("Template deleted!","success")}catch(e){console.error("Error deleting template:",e),A("Failed to delete template","error")}}return(0,s.useEffect)(()=>{e&&U()},[e,l]),(0,t.jsx)(d.Dialog,{open:e,onOpenChange:a,children:(0,t.jsxs)(d.DialogContent,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsxs)(d.DialogHeader,{children:[(0,t.jsx)(d.DialogTitle,{children:"Message Templates"}),(0,t.jsxs)(d.DialogDescription,{children:["Pre-written messages with variables. Use: ","{{customer_name}}",", ","{{job_date}}",", ","{{job_time}}",", ","{{job_address}}",", ","{{amount}}",", ","{{invoice_link}}"]})]}),(0,t.jsxs)("div",{className:"space-y-4 mt-4",children:[!D&&(0,t.jsxs)(c.Button,{onClick:()=>F(!0),className:"w-full",variant:"outline",children:[(0,t.jsx)(v.Plus,{className:"mr-2 h-4 w-4"}),"Create New Template"]}),D&&(0,t.jsxs)("div",{className:"rounded-lg border p-4 space-y-3",children:[(0,t.jsxs)("div",{className:"grid gap-3 sm:grid-cols-2",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"templateName",children:"Template Name *"}),(0,t.jsx)(m.Input,{id:"templateName",value:$,onChange:e=>P(e.target.value),placeholder:"e.g., Job Scheduled"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"templateType",children:"Type *"}),(0,t.jsxs)(x.Select,{id:"templateType",value:B,onChange:e=>E(e.target.value),children:[(0,t.jsx)("option",{value:"sms",children:"SMS"}),(0,t.jsx)("option",{value:"email",children:"Email"})]})]})]}),"email"===B&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"templateSubject",children:"Subject"}),(0,t.jsx)(m.Input,{id:"templateSubject",value:L,onChange:e=>I(e.target.value),placeholder:"Email subject..."})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"templateBody",children:"Message *"}),(0,t.jsx)(h.Textarea,{id:"templateBody",value:M,onChange:e=>O(e.target.value),placeholder:"Hey {{customer_name}} â€” just a reminder...",rows:4})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(c.Button,{onClick:R,disabled:!$.trim()||!M.trim(),children:"Save Template"}),(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>{F(!1),P(""),O(""),I("")},children:"Cancel"})]})]}),T?(0,t.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"Loading templates..."}):0===k.length?(0,t.jsxs)("div",{className:"text-center py-8 text-muted-foreground",children:[(0,t.jsx)(N.FileText,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),(0,t.jsx)("p",{children:"No templates yet"})]}):(0,t.jsx)("div",{className:"space-y-2",children:k.map(e=>{let s=z(e.body);return(0,t.jsxs)("div",{className:"rounded-lg border p-4 space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("h4",{className:"font-medium",children:e.name}),(0,t.jsx)("span",{className:"text-xs px-2 py-0.5 rounded bg-muted",children:e.type.toUpperCase()})]}),"email"===e.type&&e.subject&&(0,t.jsxs)("p",{className:"text-sm text-muted-foreground mt-1",children:["Subject: ",z(e.subject)]}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-2 whitespace-pre-wrap",children:s})]}),(0,t.jsx)(c.Button,{size:"sm",variant:"ghost",onClick:()=>Q(e.id),children:(0,t.jsx)(y.Trash2,{className:"h-4 w-4"})})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(c.Button,{size:"sm",variant:"outline",onClick:()=>{let t;return t=z(e.body),void((0,i.copyToClipboard)(t),A("Message copied!","success"))},className:"flex-1",children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy"]}),(0,t.jsx)(c.Button,{size:"sm",onClick:()=>(function(e){let t=z(e.body);if("sms"===e.type&&o?.phone)window.location.href=`sms:${o.phone}?body=${encodeURIComponent(t)}`;else if("email"===e.type&&o?.email){let s=e.subject?z(e.subject):"Message from Drip";window.location.href=`mailto:${o.email}?subject=${encodeURIComponent(s)}&body=${encodeURIComponent(t)}`}else A(`No ${"sms"===e.type?"phone":"email"} available`,"error")})(e),className:"flex-1",disabled:"sms"===e.type&&!o?.phone||"email"===e.type&&!o?.email,children:"sms"===e.type?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.Send,{className:"mr-2 h-4 w-4"}),"Send SMS"]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(b.Mail,{className:"mr-2 h-4 w-4"}),"Send Email"]})})]})]},e.id)})})]})]})})}var _=e.i(24470);let S=(0,j.default)("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);function k({open:e,onOpenChange:a,mode:i,jobId:l,companyId:n,onRefresh:o}){let[x,j]=(0,s.useState)(!1),[g,f]=(0,s.useState)([]),[v,N]=(0,s.useState)(""),[b,w]=(0,s.useState)(""),[k,C]=(0,s.useState)(!0),[T,q]=(0,s.useState)(!0),[D,F]=(0,s.useState)(!1),{addToast:$}=(0,p.useToast)();async function P(){try{let e=await fetch("/api/job-templates");if(!e.ok)throw Error("Failed to load templates");let t=await e.json();f(t)}catch(e){console.error("Error loading templates:",e),$("Failed to load templates","error")}}async function B(){if(!v.trim())return void $("Please enter a template name","error");if(!l)return void $("No job selected","error");j(!0);try{let e=await fetch("/api/job-templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:l,name:v.trim(),description:b.trim()||null,include_notes:k,include_materials:T,include_estimate_structure:D})});if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to save template")}$("Template saved successfully!","success"),N(""),w(""),C(!0),q(!0),F(!1),a(!1),o?.()}catch(e){console.error("Error saving template:",e),$(e.message||"Failed to save template","error")}finally{j(!1)}}async function E(e){if(confirm("Are you sure you want to delete this template?"))try{if(!(await fetch(`/api/job-templates/${e}`,{method:"DELETE"})).ok)throw Error("Failed to delete template");$("Template deleted","success"),P(),o?.()}catch(e){console.error("Error deleting template:",e),$("Failed to delete template","error")}}return(0,r.createClient)(),(0,s.useEffect)(()=>{e&&"manage"===i&&P()},[e,i]),(0,t.jsx)(d.Dialog,{open:e,onOpenChange:a,children:(0,t.jsxs)(d.DialogContent,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsxs)(d.DialogHeader,{children:[(0,t.jsx)(d.DialogTitle,{children:"save"===i?"Save as Template":"Manage Templates"}),(0,t.jsx)(d.DialogDescription,{children:"save"===i?"Create a reusable template from this job":`Manage your job templates (${g.length}/50)`})]}),"save"===i?(0,t.jsxs)("div",{className:"space-y-4 mt-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"templateName",children:"Template Name *"}),(0,t.jsx)(m.Input,{id:"templateName",placeholder:"e.g., Standard Interior Repaint",value:v,onChange:e=>N(e.target.value),autoFocus:!0,className:"min-h-[44px]"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"templateDescription",children:"Description (Optional)"}),(0,t.jsx)(h.Textarea,{id:"templateDescription",placeholder:"Add details about when to use this template...",value:b,onChange:e=>w(e.target.value),rows:3})]}),(0,t.jsxs)("div",{className:"rounded-lg border bg-muted/30 p-4 space-y-3",children:[(0,t.jsx)("p",{className:"text-sm font-medium",children:"What to include:"}),(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)(_.SimpleCheckbox,{id:"includeNotes",checked:k,onChange:e=>C(e.target.checked)}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)(u.Label,{htmlFor:"includeNotes",className:"cursor-pointer font-normal",children:"Notes"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Copy job notes to template"})]})]}),(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)(_.SimpleCheckbox,{id:"includeMaterials",checked:T,onChange:e=>q(e.target.checked)}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)(u.Label,{htmlFor:"includeMaterials",className:"cursor-pointer font-normal",children:"Materials"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Save materials list for reuse"})]})]}),(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)(_.SimpleCheckbox,{id:"includeEstimateStructure",checked:D,onChange:e=>F(e.target.checked)}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)(u.Label,{htmlFor:"includeEstimateStructure",className:"cursor-pointer font-normal",children:"Estimate Structure"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Save line item names (prices not included)"})]})]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-3 pt-4",children:[(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>a(!1),disabled:x,children:"Cancel"}),(0,t.jsxs)(c.Button,{onClick:B,loading:x,children:[(0,t.jsx)(S,{className:"mr-2 h-4 w-4"}),"Save Template"]})]})]}):(0,t.jsx)("div",{className:"space-y-4 mt-4",children:0===g.length?(0,t.jsxs)("div",{className:"p-8 text-center text-muted-foreground",children:[(0,t.jsx)("p",{children:"No templates yet"}),(0,t.jsx)("p",{className:"text-sm mt-1",children:"Save your first template from a job detail page"})]}):(0,t.jsx)("div",{className:"space-y-3",children:g.map(e=>(0,t.jsx)("div",{className:"rounded-lg border bg-card p-4 space-y-2",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h4",{className:"font-medium",children:e.name}),e.description&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-1",children:e.description}),(0,t.jsxs)("div",{className:"flex gap-4 mt-2 text-xs text-muted-foreground",children:[e.template_materials&&(0,t.jsxs)("span",{children:[e.template_materials.length," materials"]}),e.template_estimate_items&&(0,t.jsxs)("span",{children:[e.template_estimate_items.length," estimate items"]}),e.notes&&(0,t.jsx)("span",{children:"Has notes"})]})]}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>E(e.id),className:"text-destructive hover:text-destructive hover:bg-destructive/10",children:(0,t.jsx)(y.Trash2,{className:"h-4 w-4"})})]})},e.id))})})]})})}var C=e.i(73708);let T=(0,j.default)("image-plus",[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]]);function q({jobId:e,companyId:a,compact:r=!1}){let[i,l]=(0,s.useState)([]),[n,o]=(0,s.useState)(!0),[m,u]=(0,s.useState)(!1),[h,j]=(0,s.useState)(null),[g,f]=(0,s.useState)("other"),v=(0,s.useRef)(null),{addToast:N}=(0,p.useToast)();async function b(){try{let t=await fetch(`/api/jobs/${e}/photos`);if(!t.ok)throw Error("Failed to load photos");let s=await t.json();l(s)}catch(e){console.error("Error loading photos:",e),N("Failed to load photos","error")}finally{o(!1)}}async function w(e){let t=e.target.files?.[0];t&&(t.size>0xa00000?N("File too large (max 10MB)","error"):["image/jpeg","image/jpg","image/png","image/webp","image/heic"].includes(t.type)?await _(t):N("Invalid file type. Use JPEG, PNG, WebP, or HEIC","error"))}async function _(t){u(!0);try{let s=new FormData;s.append("file",t),s.append("tag",g);let a=await fetch(`/api/jobs/${e}/photos`,{method:"POST",body:s});if(!a.ok){let e=await a.json();throw console.error("Upload error details:",e),Error(e.error||"Upload failed")}let r=await a.json();l(e=>[r,...e]),N("Photo uploaded!","success"),v.current&&(v.current.value="")}catch(e){console.error("Upload error:",e),N(e.message||"Failed to upload photo","error")}finally{u(!1)}}async function S(t){if(confirm("Delete this photo? This cannot be undone."))try{if(!(await fetch(`/api/jobs/${e}/photos/${t}`,{method:"DELETE"})).ok)throw Error("Failed to delete photo");l(e=>e.filter(e=>e.id!==t)),j(null),N("Photo deleted","success")}catch(e){console.error("Delete error:",e),N("Failed to delete photo","error")}}return(0,s.useEffect)(()=>{b()},[e]),(0,t.jsxs)("div",{className:"space-y-4",children:[!r&&(0,t.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,t.jsx)("input",{ref:v,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp,image/heic",onChange:w,className:"hidden"}),(0,t.jsxs)(x.Select,{value:g,onChange:e=>f(e.target.value),className:"flex-1 min-h-[44px]",children:[(0,t.jsx)("option",{value:"before",children:"Before"}),(0,t.jsx)("option",{value:"after",children:"After"}),(0,t.jsx)("option",{value:"other",children:"Other"})]}),(0,t.jsxs)(c.Button,{onClick:()=>v.current?.click(),disabled:m,loading:m,className:"flex-1 touch-target min-h-[44px]",children:[(0,t.jsx)(T,{className:"mr-2 h-4 w-4"}),m?"Uploading...":"Add Photo"]})]}),n&&(0,t.jsxs)("div",{className:"p-8 text-center text-muted-foreground",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),(0,t.jsx)("p",{className:"text-sm",children:"Loading photos..."})]}),!n&&0===i.length&&(0,t.jsxs)("div",{className:"p-8 text-center text-muted-foreground rounded-lg border bg-muted/30",children:[(0,t.jsx)(C.Image,{className:"mx-auto h-8 w-8 mb-2"}),(0,t.jsx)("p",{children:"No photos yet"}),(0,t.jsx)("p",{className:"text-xs mt-1",children:"Take or upload photos to document this job"})]}),!n&&i.length>0&&(0,t.jsx)("div",{className:r?"flex items-center gap-2":"grid grid-cols-2 sm:grid-cols-3 gap-3",children:r?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[(0,t.jsx)(C.Image,{className:"h-4 w-4"}),(0,t.jsxs)("span",{children:[i.length," photo",1!==i.length?"s":""]})]}),i.slice(0,3).map(e=>(0,t.jsx)("button",{onClick:()=>j(e),className:"w-12 h-12 rounded overflow-hidden bg-muted hover:opacity-80 transition-opacity",children:(0,t.jsx)("img",{src:e.public_url,alt:e.caption||"Photo",className:"w-full h-full object-cover"})},e.id))]}):i.map(e=>(0,t.jsxs)("button",{onClick:()=>j(e),className:"aspect-square rounded-lg overflow-hidden bg-muted hover:opacity-80 transition-opacity relative",children:[(0,t.jsx)("img",{src:e.public_url,alt:e.caption||"Photo",className:"w-full h-full object-cover"}),e.tag&&(0,t.jsx)("span",{className:"absolute top-2 left-2 text-xs bg-black/60 text-white px-2 py-1 rounded",children:e.tag})]},e.id))}),(0,t.jsx)(d.Dialog,{open:!!h,onOpenChange:e=>!e&&j(null),children:(0,t.jsxs)(d.DialogContent,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Photo"})}),h&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("img",{src:h.public_url,alt:h.caption||"Photo",className:"w-full rounded-lg"}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"text-sm text-muted-foreground space-y-1",children:[(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:"Tag:"})," ",h.tag||"other"]}),h.file_name&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:"File:"})," ",h.file_name]}),h.caption&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:"Caption:"})," ",h.caption]})]}),(0,t.jsxs)(c.Button,{variant:"destructive",size:"sm",onClick:()=>S(h.id),children:[(0,t.jsx)(y.Trash2,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]})]})})]})}var D=e.i(95613);let F=(0,j.default)("pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);var $=e.i(43531),P=e.i(12426);let B=(0,j.default)("share-2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);var E=e.i(88699);function L({jobId:e,companyId:l,customerId:n,paymentState:o,paymentAmount:j,paymentApprovedAt:f,paymentPaidAt:N,paymentMethod:b,publicToken:w,lineItems:_,estimatingConfig:S,estimateStatus:k,estimateDeniedAt:C,estimateDenialReason:T,onUpdate:q}){let L=(0,r.createClient)(),{addToast:I}=(0,p.useToast)();(0,a.useRouter)();let[M,O]=(0,s.useState)(o),[A,H]=(0,s.useState)(N),[U,z]=(0,s.useState)(b);(0,s.useEffect)(()=>{O(o)},[o]),(0,s.useEffect)(()=>{H(N)},[N]),(0,s.useEffect)(()=>{z(b)},[b]);let[R,Q]=(0,s.useState)(_.length>0?_.map(e=>({id:e.id,type:"other",title:e.title,price:(e.price/100).toFixed(2),paintBrand:"",paintColor:"",paintSheen:"",paintQuantity:"",paintQuantityUnit:"gal"})):[{type:"other",title:"",price:"",paintBrand:"",paintColor:"",paintSheen:"",paintQuantity:"",paintQuantityUnit:"gal"}]),[W,G]=(0,s.useState)(!1),[J,V]=(0,s.useState)(!1),[X,K]=(0,s.useState)("cash"),[Y,Z]=(0,s.useState)(!1),[ee,et]=(0,s.useState)(!1),[es,ea]=(0,s.useState)(!1),[er,ei]=(0,s.useState)(!1),[el,en]=(0,s.useState)(["cash","check","venmo","stripe"]),[eo,ed]=(0,s.useState)(w),[ec,em]=(0,s.useState)(),[eu,eh]=(0,s.useState)(!1),[ex,ep]=(0,s.useState)(!1);async function ej(){et(!0);try{let{data:t}=await L.from("estimates").select("id").eq("job_id",e).maybeSingle();if(!t)return void et(!1);let{data:s}=await L.from("estimate_line_items").select("*").eq("estimate_id",t.id).order("created_at",{ascending:!0});if(s&&s.length>0){let e=s.map(e=>{let t,s="other";if("sqft"===e.service_type){s="area";let a=e.name.toLowerCase();t=a.includes("exterior")&&a.includes("walls")?"exterior_walls":a.includes("exterior")&&a.includes("trim")?"exterior_trim":a.includes("deck")||a.includes("fence")?"deck_fence":a.includes("siding")?"siding":a.includes("walls")?"walls":a.includes("ceiling")?"ceilings":a.includes("trim")?"trim":a.includes("door")?"doors":"other"}return{id:e.id,type:s,title:e.name,price:(e.price/100).toFixed(2),areaType:t,sqft:e.sqft?.toString()||"",ratePerSqft:e.rate_per_sqft?.toString()||"",paintBrand:e.product_line||"",paintColor:e.paint_color_name_or_code||"",paintSheen:e.sheen||"",paintQuantity:e.gallons_estimate?.toString()||"",paintQuantityUnit:"gal"}});Q(e)}}catch(e){console.error("Error loading estimate:",e),I("Failed to load estimate details","error")}finally{et(!1)}}async function eg(){if(eo||w)return eo||w;eh(!0);try{let t,s,a=(0,i.generateToken)(24),{data:r}=await L.from("estimates").select("id, public_token").eq("job_id",e).maybeSingle();if(r){let{data:e,error:i}=await L.from("estimates").update({public_token:a,status:"sent",customer_id:n,updated_at:new Date().toISOString()}).eq("id",r.id).select("public_token").single();t=e,s=i}else{let{data:r,error:i}=await L.from("estimates").insert({company_id:l,job_id:e,customer_id:n,status:"sent",public_token:a}).select("public_token").single();t=r,s=i}if(s)return console.error("Estimate create/update error:",s),ed(a),a;if(t)return ed(t.public_token),t.public_token}catch(t){console.error("Error ensuring public token:",t);let e=(0,i.generateToken)(24);return ed(e),e}finally{eh(!1)}}(0,s.useEffect)(()=>{!async function(){if(!eo&&e&&"proposed"===o){eh(!0);try{let{data:t}=await L.from("estimates").select("public_token").eq("job_id",e).maybeSingle();t?.public_token&&ed(t.public_token)}catch(e){console.error("Error fetching estimate token:",e)}finally{eh(!1)}}}()},[e,o,eo,L]),(0,s.useEffect)(()=>{!async function(){if(!ec&&e&&"due"===o){ep(!0);try{let{data:t}=await L.from("jobs").select("payment_token").eq("id",e).single();t?.payment_token&&em(t.payment_token)}catch(e){console.error("Error fetching payment token:",e)}finally{ep(!1)}}}()},[e,o,ec,L]);let ef=R.reduce((e,t)=>"area"===t.type&&t.ratePerSqft&&t.sqft?e+Math.round((parseFloat(t.ratePerSqft)||0)*(parseFloat(t.sqft)||0)*100):"labor"===t.type&&t.hours&&t.ratePerHour?e+Math.round((parseFloat(t.hours)||0)*(parseFloat(t.ratePerHour)||0)*100):e+Math.round(100*(parseFloat(t.price)||0)),0),ev=(e,t,s)=>{let a=[...R];a[e][t]=s,"type"===t&&("area"===s?(a[e].areaType="walls",a[e].ratePerSqft=S?.walls_rate_per_sqft?.toString()||"",a[e].sqft=""):"labor"===s&&(a[e].hours="",a[e].ratePerHour=S?.labor_rate_per_hour?.toString()||""),a[e].price=""),"areaType"===t&&"walls"===s?a[e].ratePerSqft=S?.walls_rate_per_sqft?.toString()||"":"areaType"===t&&"ceilings"===s?a[e].ratePerSqft=S?.ceilings_rate_per_sqft?.toString()||"":"areaType"===t&&("trim"===s||"doors"===s)&&(a[e].ratePerSqft=S?.trim_rate_per_sqft?.toString()||""),Q(a)};async function ey(){if(!R.some(e=>"area"===e.type?e.ratePerSqft&&e.sqft&&parseFloat(e.ratePerSqft)>0&&parseFloat(e.sqft)>0:"labor"===e.type?e.hours&&e.ratePerHour&&parseFloat(e.hours)>0&&parseFloat(e.ratePerHour)>0:e.title.trim()&&e.price.trim()&&parseFloat(e.price)>0))return void I("Please add at least one complete line item","error");G(!0);try{let t,s,a,r={payment_state:"proposed",payment_amount:ef};"approved"===M&&(r.payment_approved_at=null);let{error:o}=await L.from("jobs").update(r).eq("id",e);if(o)throw console.error("Job update error:",o),o;O("proposed");let{error:d}=await L.from("job_payment_line_items").delete().eq("job_id",e);if(d)throw console.error("Delete line items error:",d),d;let c=R.filter(e=>"area"===e.type?e.ratePerSqft&&e.sqft&&parseFloat(e.ratePerSqft)>0&&parseFloat(e.sqft)>0:"labor"===e.type?e.hours&&e.ratePerHour&&parseFloat(e.hours)>0&&parseFloat(e.ratePerHour)>0:e.title.trim()&&e.price.trim()&&parseFloat(e.price)>0).map((t,s)=>{let a="",r=0;return"area"===t.type&&t.areaType&&t.ratePerSqft&&t.sqft?(a=`${({walls:"Interior Walls",ceilings:"Ceilings",trim:"Interior Trim",doors:"Doors",exterior_walls:"Exterior Walls",exterior_trim:"Exterior Trim",deck_fence:"Deck/Fence",siding:"Siding",other:"Other"})[t.areaType]} - ${t.sqft} sqft @ $${t.ratePerSqft}/sqft`,r=Math.round((parseFloat(t.ratePerSqft)||0)*(parseFloat(t.sqft)||0)*100)):"labor"===t.type&&t.hours&&t.ratePerHour?(a=`Labor - ${t.hours} hrs @ $${t.ratePerHour}/hr`,r=Math.round((parseFloat(t.hours)||0)*(parseFloat(t.ratePerHour)||0)*100)):(a=t.title.trim(),r=Math.round(100*(parseFloat(t.price)||0))),{job_id:e,title:a,price:r,sort_order:s}});if(0===c.length)throw Error("No valid line items to save");let{error:m}=await L.from("job_payment_line_items").insert(c);if(m)throw console.error("Items insert error:",m),m;let u=eo||(0,i.generateToken)(24),{data:h}=await L.from("estimates").select("id, public_token").eq("job_id",e).maybeSingle();if(h){let{data:e,error:r}=await L.from("estimates").update({public_token:u,status:"sent",customer_id:n,accepted_at:null,updated_at:new Date().toISOString()}).eq("id",h.id).select("id, public_token").single();s=e,a=r,t=h.id}else{let{data:r,error:i}=await L.from("estimates").insert({company_id:l,job_id:e,customer_id:n,status:"sent",public_token:u}).select("id, public_token").single();s=r,a=i,t=r?.id||""}if(a)console.error("Estimate create/update error:",a);else if(s&&t){ed(s.public_token),await L.from("estimate_line_items").delete().eq("estimate_id",t);let e=R.filter(e=>"area"===e.type?e.ratePerSqft&&e.sqft&&parseFloat(e.ratePerSqft)>0&&parseFloat(e.sqft)>0:"labor"===e.type?e.hours&&e.ratePerHour&&parseFloat(e.hours)>0&&parseFloat(e.ratePerHour)>0:e.title.trim()&&e.price.trim()&&parseFloat(e.price)>0).map(e=>{let s="",a=0,r="flat";return"area"===e.type&&e.areaType&&e.ratePerSqft&&e.sqft?(s=({walls:"Interior Walls",ceilings:"Ceilings",trim:"Interior Trim",doors:"Doors",exterior_walls:"Exterior Walls",exterior_trim:"Exterior Trim",deck_fence:"Deck/Fence",siding:"Siding",other:"Other"})[e.areaType],a=Math.round((parseFloat(e.ratePerSqft)||0)*(parseFloat(e.sqft)||0)*100),r="sqft"):"labor"===e.type&&e.hours&&e.ratePerHour?(s="Labor",a=Math.round((parseFloat(e.hours)||0)*(parseFloat(e.ratePerHour)||0)*100)):(s=e.title.trim(),a=Math.round(100*(parseFloat(e.price)||0))),{estimate_id:t,service_key:"other",service_type:r,name:s,description:null,price:a,sqft:"area"===e.type&&e.sqft?parseFloat(e.sqft):null,rate_per_sqft:"area"===e.type&&e.ratePerSqft?parseFloat(e.ratePerSqft):null,paint_color_name_or_code:e.paintColor||null,sheen:e.paintSheen||null,product_line:e.paintBrand||null,gallons_estimate:e.paintQuantity?parseFloat(e.paintQuantity):null}});if(e.length>0){await L.from("estimate_line_items").insert(e);try{await fetch(`/api/estimate-materials/${t}/generate`,{method:"POST"})}catch(e){console.error("Failed to auto-generate materials:",e)}}}"approved"===M?(I("Estimate revised - customer needs to approve again","success"),O("proposed")):I("Estimate saved","success"),Z(!1),setTimeout(()=>q(),100)}catch(t){console.error("Failed to save payment:",t),console.error("Error details:",{message:t?.message,code:t?.code,details:t?.details,hint:t?.hint,fullError:t});let e=t?.message||t?.code||t?.details||JSON.stringify(t)||"Unknown error";I(`Failed to save: ${e}`,"error")}finally{G(!1)}}async function eN(){let e=await eg();if(!e)return void I("Unable to generate link","error");let t=`${window.location.origin}/e/${e}`;(0,i.copyToClipboard)(t),I("Estimate link copied to clipboard","success"),ea(!1)}async function eb(){let e=await eg();if(!e)return void I("Unable to generate link","error");let t=`${window.location.origin}/e/${e}`,s=`Hey there â€” here's your estimate for ${(0,i.formatCurrency)(j||ef)}: ${t}. Let me know if you have any questions!`;(0,i.copyToClipboard)(s),I("Message copied to clipboard","success"),ea(!1)}async function ew(){G(!0);try{let{error:t}=await L.from("jobs").update({payment_state:"approved",payment_approved_at:new Date().toISOString()}).eq("id",e);if(t)throw t;O("approved"),I("Price approved! ðŸŽ‰","success"),q()}catch(e){console.error("Failed to approve:",e),I("Failed to approve","error")}finally{G(!1)}}async function e_(){if(ec)return ec;ep(!0);try{let{data:t}=await L.from("jobs").select("payment_token").eq("id",e).single();if(t?.payment_token)return em(t.payment_token),t.payment_token;let s=(0,i.generateToken)(24),{error:a}=await L.from("jobs").update({payment_token:s}).eq("id",e);if(a)throw a;return em(s),s}catch(e){return console.error("Failed to generate payment token:",e),I("Failed to generate payment link","error"),null}finally{ep(!1)}}async function eS(){let t=el.length>0?el:["cash","check","venmo","stripe"];G(!0);try{let s=await e_();if(!s)return void G(!1);let{error:a}=await L.from("jobs").update({payment_state:"due",payment_token:s,payment_methods:t}).eq("id",e);if(a)throw a;O("due"),I("Payment requested","success"),q()}catch(e){console.error("Failed to mark due:",e),I("Failed to request payment","error")}finally{G(!1)}}async function ek(){G(!0);try{let{error:t}=await L.from("jobs").update({payment_state:"paid",payment_paid_at:new Date().toISOString(),payment_method:X,status:"paid",updated_at:new Date().toISOString()}).eq("id",e);if(t)throw t;let s=new Date().toISOString();O("paid"),H(s),z(X),I("Payment recorded! ðŸ’°","success"),V(!1),q()}catch(e){console.error("Failed to mark paid:",e),I("Failed to record payment","error")}finally{G(!1)}}return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.Dialog,{open:es,onOpenChange:async e=>{ea(e),e&&await eg()},children:(0,t.jsxs)(d.DialogContent,{className:"max-w-lg",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Share Estimate"})}),(0,t.jsx)("div",{className:"space-y-4",children:(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Estimate Link"}),(0,t.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,t.jsx)(m.Input,{value:eu?"Generating...":eo||w?`${window.location.origin}/e/${eo||w}`:"No token available",readOnly:!0,className:"font-mono text-sm"}),(0,t.jsx)(c.Button,{variant:"outline",onClick:eN,disabled:eu,className:"shrink-0",children:(0,t.jsx)(g,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Pre-written Message"}),(0,t.jsx)(h.Textarea,{value:eu?"Generating link...":`Hey there â€” here's your estimate for ${(0,i.formatCurrency)(j||ef)}: ${eo||w?`${window.location.origin}/e/${eo||w}`:"[link will be generated]"}. Let me know if you have any questions!`,readOnly:!0,rows:4,className:"mt-2 font-sans"}),(0,t.jsxs)(c.Button,{onClick:eb,className:"w-full mt-2",disabled:eu,children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy Message"]})]})]})})]})}),(0,t.jsx)(d.Dialog,{open:er,onOpenChange:async e=>{ei(e),e&&await e_()},children:(0,t.jsxs)(d.DialogContent,{className:"max-w-lg",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Share Payment"})}),(0,t.jsx)("div",{className:"space-y-4",children:ex?(0,t.jsx)("div",{className:"text-center py-4",children:(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Generating link..."})}):ec?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"rounded-lg border bg-card p-4",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground mb-2",children:"Amount Due"}),(0,t.jsx)("p",{className:"font-semibold text-lg",children:(0,i.formatCurrency)(j||0)})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Payment Link"}),(0,t.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,t.jsx)(m.Input,{value:ec?`${window.location.origin}/p/${ec}`:"",readOnly:!0,className:"font-mono text-sm"}),(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>{let e=`${window.location.origin}/p/${ec}`;(0,i.copyToClipboard)(e),I("Payment link copied","success")},disabled:ex,className:"shrink-0",children:(0,t.jsx)(g,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Pre-written Message"}),(0,t.jsx)(h.Textarea,{value:`Hey there â€” here's your invoice for ${(0,i.formatCurrency)(j||0)}: ${ec?`${window.location.origin}/p/${ec}`:"[link will be generated]"}. Thank you!`,readOnly:!0,rows:4,className:"mt-2 font-sans"}),(0,t.jsxs)(c.Button,{onClick:()=>{let e=`${window.location.origin}/p/${ec}`,t=`Hey there â€” here's your invoice for ${(0,i.formatCurrency)(j||0)}: ${e}. Thank you!`;(0,i.copyToClipboard)(t),I("Message copied to clipboard","success"),ei(!1)},className:"w-full mt-2",disabled:ex,children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy Message"]})]})]})]}):(0,t.jsx)("div",{className:"text-center py-4",children:(0,t.jsx)("p",{className:"text-sm text-destructive",children:"No token available"})})})]})}),(0,t.jsxs)("div",{className:"rounded-lg border bg-card p-4 space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("h3",{className:"font-semibold",children:(()=>{switch(o){case"none":case"proposed":return"Estimate";case"approved":return"Agreed Price";case"due":return"Payment Due";case"paid":return"Paid";default:return"Payment"}})()}),"none"!==o&&(0,t.jsx)(D.Badge,{variant:(()=>{switch(o){case"proposed":return"secondary";case"approved":return"default";case"due":return"warning";case"paid":return"success";default:return"outline"}})(),children:o.charAt(0).toUpperCase()+o.slice(1)}),"denied"===k&&(0,t.jsx)(D.Badge,{variant:"destructive",children:"Denied"})]}),j&&(0,t.jsx)("div",{className:"text-xl font-bold",children:(0,i.formatCurrency)(j)})]}),"denied"===k&&(0,t.jsx)("div",{className:"rounded-lg border-2 border-destructive bg-destructive/10 p-4 space-y-3",children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)("div",{className:"w-6 h-6 rounded-full bg-destructive text-white flex items-center justify-center shrink-0 mt-0.5",children:"âœ—"}),(0,t.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-semibold text-destructive",children:"Customer Declined Estimate"}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground mt-1",children:["Declined on ",(0,i.formatDate)(C||new Date().toISOString())]})]}),T&&(0,t.jsxs)("div",{className:"bg-card p-3 rounded-lg border",children:[(0,t.jsx)("p",{className:"text-sm font-medium mb-1",children:"Customer Feedback:"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:T})]}),(0,t.jsx)("div",{className:"flex gap-2 pt-2",children:(0,t.jsxs)(c.Button,{variant:"outline",size:"sm",onClick:async()=>{await ej(),Z(!0)},disabled:ee,children:[(0,t.jsx)(F,{className:"h-4 w-4 mr-2"}),ee?"Loading...":"Revise Estimate"]})}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Review the customer's feedback and revise the estimate. You can adjust pricing, scope, or send a message to discuss their concerns."})]})]})}),("none"===M||"proposed"===M||"approved"===M&&Y)&&(0,t.jsx)("div",{className:"space-y-4",children:"proposed"===M&&_.length>0&&!Y?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"rounded-lg border bg-muted/30 p-4 space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h4",{className:"font-medium text-sm",children:"Estimate Total"}),(0,t.jsx)("span",{className:"text-lg font-bold",children:(0,i.formatCurrency)(j||ef)})]}),(0,t.jsx)("div",{className:"space-y-1",children:_.map(e=>(0,t.jsxs)("div",{className:"flex justify-between text-sm text-muted-foreground",children:[(0,t.jsx)("span",{children:e.title}),(0,t.jsx)("span",{children:(0,i.formatCurrency)(e.price)})]},e.id))})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(c.Button,{variant:"outline",onClick:async()=>{await eg(),ea(!0)},className:"flex-1",children:[(0,t.jsx)(B,{className:"mr-2 h-4 w-4"}),"Share Estimate"]}),(0,t.jsxs)(c.Button,{variant:"outline",onClick:async()=>{await ej(),Z(!0)},disabled:ee,className:"flex-1",children:[(0,t.jsx)(E.Pencil,{className:"mr-2 h-4 w-4"}),ee?"Loading...":"Edit"]}),n&&(0,t.jsxs)(c.Button,{variant:"default",onClick:ew,loading:W,className:"flex-1",children:[(0,t.jsx)($.Check,{className:"mr-2 h-4 w-4"}),"Approve"]})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"rounded-lg border bg-muted/30 p-4 space-y-4",children:[R.map((e,s)=>{let a="area"===e.type&&e.ratePerSqft&&e.sqft?(parseFloat(e.ratePerSqft)||0)*(parseFloat(e.sqft)||0):"labor"===e.type&&e.hours&&e.ratePerHour?(parseFloat(e.hours)||0)*(parseFloat(e.ratePerHour)||0):parseFloat(e.price)||0;return(0,t.jsxs)("div",{className:"p-3 sm:p-4 rounded-lg border bg-card space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,t.jsxs)(x.Select,{value:e.type,onChange:e=>ev(s,"type",e.target.value),className:"flex-1 min-h-[44px]",children:[(0,t.jsx)("option",{value:"area",children:"Area"}),(0,t.jsx)("option",{value:"labor",children:"Labor"}),(0,t.jsx)("option",{value:"other",children:"Other"})]}),R.length>1&&(0,t.jsx)("button",{onClick:()=>{1!==R.length&&Q(R.filter((e,t)=>t!==s))},className:"text-muted-foreground hover:text-destructive min-h-[44px] w-11 flex items-center justify-center shrink-0 touch-target","aria-label":"Remove line item",children:(0,t.jsx)(y.Trash2,{className:"h-5 w-5"})})]}),"area"===e.type?(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground mb-1",children:"Area Type"}),(0,t.jsxs)(x.Select,{value:e.areaType||"walls",onChange:e=>ev(s,"areaType",e.target.value),className:"w-full min-h-[44px]",children:[(0,t.jsxs)("optgroup",{label:"Interior",children:[(0,t.jsx)("option",{value:"walls",children:"Interior Walls"}),(0,t.jsx)("option",{value:"ceilings",children:"Ceilings"}),(0,t.jsx)("option",{value:"trim",children:"Interior Trim"}),(0,t.jsx)("option",{value:"doors",children:"Doors"})]}),(0,t.jsxs)("optgroup",{label:"Exterior",children:[(0,t.jsx)("option",{value:"exterior_walls",children:"Exterior Walls"}),(0,t.jsx)("option",{value:"exterior_trim",children:"Exterior Trim"}),(0,t.jsx)("option",{value:"deck_fence",children:"Deck/Fence"}),(0,t.jsx)("option",{value:"siding",children:"Siding"})]}),(0,t.jsx)("option",{value:"other",children:"Other"})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground mb-1",children:"Square Feet"}),(0,t.jsx)(m.Input,{type:"number",step:"0.01",min:"0",placeholder:"0",value:e.sqft||"",onChange:e=>ev(s,"sqft",e.target.value),className:"min-h-[44px]"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground mb-1",children:"Rate ($/sqft)"}),(0,t.jsx)(m.Input,{type:"number",step:"0.01",min:"0",placeholder:"0.00",value:e.ratePerSqft||"",onChange:e=>ev(s,"ratePerSqft",e.target.value),className:"min-h-[44px]"})]})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between pt-2 border-t",children:[(0,t.jsx)("span",{className:"text-sm font-medium text-muted-foreground",children:"Total"}),(0,t.jsx)("span",{className:"text-lg font-bold",children:(0,i.formatCurrency)(Math.round(100*a))})]}),(0,t.jsxs)("div",{className:"pt-3 border-t space-y-3",children:[(0,t.jsx)(u.Label,{className:"text-xs font-semibold",children:"Paint Details"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground",children:"Brand"}),(0,t.jsxs)(x.Select,{value:e.paintBrand||"",onChange:e=>ev(s,"paintBrand",e.target.value),className:"min-h-[44px]",children:[(0,t.jsx)("option",{value:"",children:"Select brand..."}),(0,t.jsx)("option",{value:"Sherwin-Williams",children:"Sherwin-Williams"}),(0,t.jsx)("option",{value:"Benjamin Moore",children:"Benjamin Moore"}),(0,t.jsx)("option",{value:"Behr",children:"Behr"}),(0,t.jsx)("option",{value:"PPG",children:"PPG"}),(0,t.jsx)("option",{value:"Other",children:"Other"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground",children:"Color"}),(0,t.jsx)(m.Input,{placeholder:"e.g., SW 7008 Alabaster",value:e.paintColor||"",onChange:e=>ev(s,"paintColor",e.target.value),className:"min-h-[44px]"})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground",children:"Sheen"}),(0,t.jsxs)(x.Select,{value:e.paintSheen||"",onChange:e=>ev(s,"paintSheen",e.target.value),className:"min-h-[44px]",children:[(0,t.jsx)("option",{value:"",children:"Select sheen..."}),(0,t.jsx)("option",{value:"Flat",children:"Flat"}),(0,t.jsx)("option",{value:"Matte",children:"Matte"}),(0,t.jsx)("option",{value:"Eggshell",children:"Eggshell"}),(0,t.jsx)("option",{value:"Satin",children:"Satin"}),(0,t.jsx)("option",{value:"Semi-Gloss",children:"Semi-Gloss"}),(0,t.jsx)("option",{value:"Gloss",children:"Gloss"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground",children:"Quantity"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(m.Input,{type:"number",min:"0",step:"0.25",placeholder:"e.g., 3",value:e.paintQuantity||"",onChange:e=>ev(s,"paintQuantity",e.target.value),className:"min-h-[44px] flex-1"}),(0,t.jsxs)(x.Select,{value:e.paintQuantityUnit||"gal",onChange:e=>ev(s,"paintQuantityUnit",e.target.value),className:"min-h-[44px] w-28",children:[(0,t.jsx)("option",{value:"gal",children:"Gallons"}),(0,t.jsx)("option",{value:"qt",children:"Quarts"}),(0,t.jsx)("option",{value:"pt",children:"Pints"}),(0,t.jsx)("option",{value:"oz",children:"Oz"})]})]})]})]})]})]}):"labor"===e.type?(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground mb-1",children:"Hours"}),(0,t.jsx)(m.Input,{type:"number",step:"0.25",min:"0",placeholder:"0",value:e.hours||"",onChange:e=>ev(s,"hours",e.target.value),className:"min-h-[44px]"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground mb-1",children:"Rate ($/hr)"}),(0,t.jsx)(m.Input,{type:"number",step:"0.01",min:"0",placeholder:"0.00",value:e.ratePerHour||"",onChange:e=>ev(s,"ratePerHour",e.target.value),className:"min-h-[44px]"})]})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between pt-2 border-t",children:[(0,t.jsx)("span",{className:"text-sm font-medium text-muted-foreground",children:"Total"}),(0,t.jsx)("span",{className:"text-lg font-bold",children:(0,i.formatCurrency)(Math.round(100*a))})]})]}):(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground mb-1",children:"Description"}),(0,t.jsx)(m.Input,{placeholder:"e.g., Materials, Travel, etc.",value:e.title,onChange:e=>ev(s,"title",e.target.value),className:"w-full min-h-[44px]"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-xs text-muted-foreground mb-1",children:"Amount"}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground",children:"$"}),(0,t.jsx)(m.Input,{type:"number",step:"0.01",min:"0.01",placeholder:"0.00",value:e.price,onChange:e=>ev(s,"price",e.target.value),className:"pl-7 min-h-[44px]"})]})]})]})]},s)}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(c.Button,{type:"button",variant:"outline",size:"sm",onClick:()=>{Q([...R,{type:"other",title:"",price:"",paintBrand:"",paintColor:"",paintSheen:"",paintQuantity:"",paintQuantityUnit:"gal"}])},className:"flex-1 touch-target min-h-[44px]",children:[(0,t.jsx)(v.Plus,{className:"mr-2 h-4 w-4"}),"Add Line"]}),(0,t.jsx)(c.Button,{onClick:ey,loading:W,disabled:R.every(e=>"area"===e.type?!e.ratePerSqft||!e.sqft||0>=parseFloat(e.ratePerSqft||"0")||0>=parseFloat(e.sqft||"0"):"labor"===e.type?!e.hours||!e.ratePerHour||0>=parseFloat(e.hours||"0")||0>=parseFloat(e.ratePerHour||"0"):!e.title.trim()||!e.price.trim()||0>=parseFloat(e.price)),className:"flex-1 touch-target min-h-[44px]",children:"proposed"===M||"approved"===M&&Y?"Update Estimate":"Create Estimate"})]})]}),Y&&(0,t.jsx)("div",{className:"flex gap-2",children:(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>{Z(!1),Q(_.length>0?_.map(e=>({id:e.id,type:"other",title:e.title,price:(e.price/100).toFixed(2)})):[{type:"other",title:"",price:""}])},className:"flex-1",children:"Cancel"})})]})}),"approved"===M&&!Y&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"rounded-lg border bg-success/10 border-success/20 p-4",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-success mb-2",children:"âœ“ Thanks for approving!"}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Price is locked at ",(0,i.formatCurrency)(j||0)]}),f&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:["Approved ",(0,i.formatDate)(f)]})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(c.Button,{variant:"outline",onClick:async()=>{await ej(),Z(!0)},disabled:ee,className:"flex-1",children:[(0,t.jsx)(F,{className:"mr-2 h-4 w-4"}),ee?"Loading...":"Revise Estimate"]}),(0,t.jsxs)(c.Button,{onClick:eS,loading:W,className:"flex-1",children:[(0,t.jsx)(P.DollarSign,{className:"mr-2 h-4 w-4"}),"Finalize Payment"]})]})]}),"due"===M&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"rounded-lg border bg-warning/10 border-warning/20 p-4",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-foreground mb-2",children:"ðŸ’° Payment Requested"}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Amount due: ",(0,i.formatCurrency)(j||0)]})]}),(0,t.jsx)("div",{className:"space-y-2",children:_.map(e=>(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{children:e.title}),(0,t.jsx)("span",{className:"font-medium",children:(0,i.formatCurrency)(e.price)})]},e.id))}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(c.Button,{variant:"outline",onClick:async()=>{await e_(),ei(!0)},className:"flex-1",children:[(0,t.jsx)(B,{className:"mr-2 h-4 w-4"}),"Share Payment"]}),(0,t.jsxs)(c.Button,{onClick:()=>V(!0),className:"flex-1",children:[(0,t.jsx)($.Check,{className:"mr-2 h-4 w-4"}),"Mark as Paid"]})]})]}),"paid"===M&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"rounded-lg border bg-success/10 border-success/20 p-4",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-success mb-2",children:"âœ“ Payment Received"}),(0,t.jsxs)("div",{className:"space-y-1 text-sm text-muted-foreground",children:[A&&(0,t.jsxs)("p",{children:["Paid on ",(0,i.formatDate)(A)]}),U&&(0,t.jsxs)("p",{className:"capitalize",children:["Method: ",U]})]})]}),(0,t.jsx)("div",{className:"space-y-2",children:_.map(e=>(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{children:e.title}),(0,t.jsx)("span",{className:"font-medium",children:(0,i.formatCurrency)(e.price)})]},e.id))})]})]}),(0,t.jsx)(d.Dialog,{open:J,onOpenChange:V,children:(0,t.jsxs)(d.DialogContent,{children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Record Payment"})}),(0,t.jsxs)("div",{className:"space-y-4 mt-4",children:[(0,t.jsxs)("div",{className:"rounded-lg bg-muted p-3",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Amount:"}),(0,t.jsx)("p",{className:"text-2xl font-bold",children:(0,i.formatCurrency)(j||0)})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{children:"Payment Method"}),(0,t.jsxs)("select",{value:X,onChange:e=>K(e.target.value),className:"w-full rounded-md border border-input bg-background px-3 py-2",children:[(0,t.jsx)("option",{value:"cash",children:"Cash"}),(0,t.jsx)("option",{value:"check",children:"Check"}),(0,t.jsx)("option",{value:"card",children:"Credit/Debit Card"}),(0,t.jsx)("option",{value:"zelle",children:"Zelle"}),(0,t.jsx)("option",{value:"venmo",children:"Venmo"}),(0,t.jsx)("option",{value:"other",children:"Other"})]})]}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>V(!1),className:"flex-1",children:"Cancel"}),(0,t.jsx)(c.Button,{onClick:ek,loading:W,className:"flex-1",children:"Record Payment"})]})]})]})})]})}var I=e.i(87316);function M({date:e,time:a,onDateChange:r,onTimeChange:n,label:o="Date & Time",className:d,disabled:c=!1}){let[h,x]=(0,s.useState)(null),p=e?new Date(e+"T00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):"";return(0,t.jsxs)("div",{className:(0,i.cn)("space-y-2",d),children:[o&&(0,t.jsx)(u.Label,{className:"text-sm font-medium",children:o}),(0,t.jsxs)("div",{className:"grid gap-3 grid-cols-1 sm:grid-cols-2",children:[(0,t.jsxs)("div",{className:"space-y-1.5",children:[(0,t.jsxs)("div",{className:(0,i.cn)("relative rounded-lg border bg-background transition-all","date"===h?"ring-2 ring-primary ring-offset-2 border-primary":"border-input hover:border-muted-foreground/50",c&&"opacity-50 cursor-not-allowed"),children:[(0,t.jsx)(I.Calendar,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10"}),(0,t.jsx)(m.Input,{type:"date",value:e||"",onChange:e=>r(e.target.value),onFocus:()=>x("date"),onBlur:()=>x(null),disabled:c,className:"pl-10 border-0 focus-visible:ring-0 focus-visible:ring-offset-0 min-h-[44px] cursor-pointer bg-transparent"})]}),p&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-1 ml-1",children:p})]}),(0,t.jsx)("div",{className:"space-y-1.5",children:(0,t.jsxs)("div",{className:(0,i.cn)("relative rounded-lg border bg-background transition-all","time"===h?"ring-2 ring-primary ring-offset-2 border-primary":"border-input hover:border-muted-foreground/50",c&&"opacity-50 cursor-not-allowed"),children:[(0,t.jsx)(l.Clock,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10"}),(0,t.jsx)(m.Input,{type:"time",value:a||"",onChange:e=>n(e.target.value),onFocus:()=>x("time"),onBlur:()=>x(null),disabled:c,className:"pl-10 border-0 focus-visible:ring-0 focus-visible:ring-offset-0 min-h-[44px] cursor-pointer bg-transparent"})]})})]})]})}var O=e.i(71689),A=e.i(46897),H=e.i(43432),U=e.i(84614),z=e.i(88844),R=e.i(37727),Q=e.i(73884),W=e.i(63059);function G({job:e,estimates:j,invoices:f,materials:N,jobHistory:C=[],teamMembers:T,companyId:F,estimatingConfig:$}){let P,G,J,V=(0,a.useRouter)(),{addToast:X}=(0,p.useToast)(),K=(0,r.createClient)(),[Y,Z]=(0,s.useState)("");(0,s.useEffect)(()=>{(async()=>{let{data:{user:e}}=await K.auth.getUser();e&&Z(e.id)})()},[K]);let[ee,et]=(0,s.useState)(e),[es,ea]=(0,s.useState)(N),[er,ei]=(0,s.useState)(j),[el,en]=(0,s.useState)(f),[eo,ed]=(0,s.useState)([]),[ec,em]=(0,s.useState)(ee.pickup_location_id||null),[eu,eh]=(0,s.useState)([]),[ex,ep]=(0,s.useState)(!1),[ej,eg]=(0,s.useState)(!1),[ef,ev]=(0,s.useState)(null),[ey,eN]=(0,s.useState)(!1),[eb,ew]=(0,s.useState)({userId:Y,hours:"",date:new Date().toISOString().split("T")[0]}),[e_,eS]=(0,s.useState)([]);(0,s.useEffect)(()=>{et(e),ea(N),ei(j),en(f),tC(e.scheduled_date||""),tq(e.scheduled_end_date||""),tF(e.scheduled_time||""),tP(!!e.scheduled_end_date)},[e.id,e.scheduled_date,e.scheduled_end_date,e.scheduled_time,N.length,j.length,f.length]),(0,s.useEffect)(()=>{let e=K.channel(`job-${ee.id}-estimates`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"estimates",filter:`job_id=eq.${ee.id}`},e=>{ei(t=>t.map(t=>t.id===e.new.id?{...t,...e.new}:t)),"accepted"===e.new.status&&"new"===ee.status&&et(e=>({...e,status:"quoted"}))}).subscribe();return()=>{K.removeChannel(e)}},[ee.id,ee.status,K]),(0,s.useEffect)(()=>{let e=K.channel(`job-${ee.id}-updates`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"jobs",filter:`id=eq.${ee.id}`},e=>{et(t=>({...t,...e.new})),void 0!==e.new.scheduled_date&&tC(e.new.scheduled_date||""),void 0!==e.new.scheduled_end_date&&tq(e.new.scheduled_end_date||""),void 0!==e.new.scheduled_time&&tF(e.new.scheduled_time||""),void 0!==e.new.scheduled_end_date&&tP(!!e.new.scheduled_end_date)}).subscribe();return()=>{K.removeChannel(e)}},[ee.id,K]),(0,s.useEffect)(()=>{let e=K.channel(`job-${ee.id}-invoices`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"invoices",filter:`job_id=eq.${ee.id}`},e=>{en(t=>t.map(t=>t.id===e.new.id?{...t,...e.new}:t)),"paid"===e.new.status&&"paid"!==ee.status&&et(e=>({...e,status:"paid"}))}).subscribe();return()=>{K.removeChannel(e)}},[ee.id,ee.status,K]),(0,s.useEffect)(()=>{let e=K.channel(`job-${ee.id}-payment-line-items`).on("postgres_changes",{event:"*",schema:"public",table:"job_payment_line_items",filter:`job_id=eq.${ee.id}`},async()=>{let{data:e}=await K.from("job_payment_line_items").select("id, title, price").eq("job_id",ee.id).order("sort_order");e&&eS(e)}).subscribe();return()=>{K.removeChannel(e)}},[ee.id,K]);let[ek,eC]=(0,s.useState)(!1),[eT,eq]=(0,s.useState)(""),[eD,eF]=(0,s.useState)(!1);(0,s.useRef)(null);let[e$,eP]=(0,s.useState)(!1),[eB,eE]=(0,s.useState)(!1),[eL,eI]=(0,s.useState)([{title:"",price:""}]),[eM,eO]=(0,s.useState)(""),[eA,eH]=(0,s.useState)(!1),[eU,ez]=(0,s.useState)(!1),[eR,eQ]=(0,s.useState)(!1),[eW,eG]=(0,s.useState)(null),[eJ,eV]=(0,s.useState)(null),[eX,eK]=(0,s.useState)(!1),[eY,eZ]=(0,s.useState)(!1),[e0,e4]=(0,s.useState)(!1),[e1,e2]=(0,s.useState)(!1),[e3,e8]=(0,s.useState)(!1),[e5,e6]=(0,s.useState)(!1),[e7,e9]=(0,s.useState)(ee.schedule_token||null),[te,tt]=(0,s.useState)(!1),[ts,ta]=(0,s.useState)("save"),[tr,ti]=(0,s.useState)(!1),[tl,tn]=(0,s.useState)("estimate"),[to,td]=(0,s.useState)("generic"),[tc,tm]=(0,s.useState)(null),[tu,th]=(0,s.useState)(!1),[tx,tp]=(0,s.useState)(!1),[tj,tg]=(0,s.useState)(!1),[tf,tv]=(0,s.useState)(!1),[ty,tN]=(0,s.useState)(!1),[tb,tw]=(0,s.useState)(!1),[t_,tS]=(0,s.useState)({name:"",brand:"",color:"",sheen:"",quantity:"",quantityUnit:"gal",productLine:"",area:"",notes:"",showAdvanced:!1}),[tk,tC]=(0,s.useState)(ee.scheduled_date||""),[tT,tq]=(0,s.useState)(ee.scheduled_end_date||""),[tD,tF]=(0,s.useState)(ee.scheduled_time||""),[t$,tP]=(0,s.useState)(!!ee.scheduled_end_date),[tB,tE]=(0,s.useState)(ee.assigned_user_id||""),[tL,tI]=(0,s.useState)(ee.notes||""),tM=[ee.address1,ee.city,ee.state,ee.zip].filter(Boolean).join(", ");async function tO(){if(e7)return e7;tt(!0);try{let e=(0,i.generateToken)(24),{error:t}=await K.from("jobs").update({schedule_token:e}).eq("id",ee.id);if(t)throw t;return e9(e),et(t=>({...t,schedule_token:e})),e}catch(e){return console.error("Failed to generate schedule token:",e),X("Failed to generate schedule link","error"),null}finally{tt(!1)}}async function tA(){if(!tk||!tD)return void X("Please set both date and time","error");if(tT&&tT<tk)return void X("End date must be after start date","error");try{let e=e7||(0,i.generateToken)(24),{error:t}=await K.from("jobs").update({scheduled_date:tk||null,scheduled_end_date:tT||null,scheduled_time:tD||null,schedule_state:"awaiting_confirmation",schedule_token:e,updated_at:new Date().toISOString()}).eq("id",ee.id);if(t)return void X("Failed to save schedule","error");et(t=>({...t,scheduled_date:tk||null,scheduled_end_date:tT||null,scheduled_time:tD||null,schedule_state:"awaiting_confirmation",schedule_token:e})),e9(e),th(!1),X("Schedule saved - awaiting customer confirmation","success")}catch(e){console.error("Save error:",e),X("Failed to save schedule","error")}}async function tH(){try{let{error:e}=await K.from("jobs").update({schedule_state:"accepted",schedule_accepted_at:new Date().toISOString(),status:"scheduled",updated_at:new Date().toISOString()}).eq("id",ee.id);if(e)return void X("Failed to accept schedule","error");et(e=>({...e,schedule_state:"accepted",schedule_accepted_at:new Date().toISOString(),status:"scheduled"})),X("Schedule accepted!","success")}catch(e){console.error("Accept error:",e),X("Failed to accept schedule","error")}}async function tU(){try{let{error:e}=await K.from("jobs").update({assigned_user_id:tB||null,updated_at:new Date().toISOString()}).eq("id",ee.id);if(e)return void X("Failed to save assignment","error");et(e=>({...e,assigned_user_id:tB||null})),X("Assignment saved","success")}catch(e){console.error("Save error:",e),X("Failed to save assignment","error")}}async function tz(){try{let{error:e}=await K.from("jobs").update({notes:tL||null,updated_at:new Date().toISOString()}).eq("id",ee.id);if(e)return void X("Failed to save notes","error");et(e=>({...e,notes:tL||null})),tv(!1),X("Notes saved","success")}catch(e){console.error("Save error:",e),X("Failed to save notes","error")}}async function tR(){if(!eb.hours||0>=parseFloat(eb.hours))return void X("Please enter valid hours","error");if(!eb.userId)return void X("Please select a worker","error");eg(!0);try{let e=parseFloat(eb.hours),t=Math.round(3600*e),s=new Date(`${eb.date}T09:00:00`),a=s.toISOString(),r=new Date(s.getTime()+1e3*t).toISOString(),{data:i,error:l}=await K.from("time_entries").insert({job_id:ee.id,company_id:F,user_id:eb.userId,started_at:a,ended_at:r,duration_seconds:t}).select(`
          id,
          user_id,
          started_at,
          ended_at,
          duration_seconds,
          user:user_id (full_name)
        `).single();if(l)throw l;let{data:n}=await K.from("time_entries").select(`
          id,
          user_id,
          started_at,
          ended_at,
          duration_seconds
        `).eq("job_id",ee.id).order("started_at",{ascending:!1});if(n){let e=[...new Set(n.map(e=>e.user_id).filter(e=>null!==e))],t={};if(e.length>0){let{data:s}=await K.from("user_profiles").select("id, full_name").in("id",e);s&&(t=s.reduce((e,t)=>(e[t.id]={full_name:t.full_name||""},e),{}))}let s=n.map(e=>({...e,user:e.user_id?t[e.user_id]:null}));eh(s)}ew({userId:Y,hours:"",date:new Date().toISOString().split("T")[0]}),X("Time entry added","success")}catch(e){console.error("Failed to add time entry:",e),X("Failed to add time entry","error")}finally{eg(!1)}}async function tQ(e,t){let s=Math.round(3600*t),a=eu.find(t=>t.id===e);if(!a)return;let r=new Date(new Date(a.started_at).getTime()+1e3*s).toISOString(),{error:i}=await K.from("time_entries").update({ended_at:r,duration_seconds:s}).eq("id",e);i?X("Failed to update time entry","error"):(eh(t=>t.map(t=>t.id===e?{...t,ended_at:r,duration_seconds:s}:t)),ev(null),X("Time entry updated","success"))}async function tW(e){let{error:t}=await K.from("time_entries").delete().eq("id",e);t?X("Failed to delete time entry","error"):(eh(t=>t.filter(t=>t.id!==e)),X("Time entry deleted","success"))}function tG(e){let t=i.JOB_STATUSES.indexOf(e);return -1===t||t===i.JOB_STATUSES.length-1?null:i.JOB_STATUSES[t+1]}async function tJ(e){let{error:t}=await K.from("jobs").update({status:e,updated_at:new Date().toISOString()}).eq("id",ee.id);t?X("Failed to update status","error"):(et(t=>({...t,status:e})),X("Status updated!","success"),V.refresh())}async function tV(){let e=t_.name.trim();if(!e)return void X("Please enter a material name","error");if("paint"===to){if(!t_.color.trim())return void X("Please enter a color","error");if(!t_.sheen)return void X("Please select a sheen","error");if(!t_.area)return void X("Please select an area","error")}let t=[],s=1,a=null;if("paint"===to)t_.brand&&t.push(t_.brand),t.push(t_.color),t.push(t_.sheen),t_.quantity&&(s=parseFloat(t_.quantity)),a=t_.quantityUnit,t_.productLine&&t.push(`(${t_.productLine})`),t_.area&&t.push(`- ${t_.area}`),t_.notes&&t.push(`| ${t_.notes}`);else{if(t_.quantity){let e=parseFloat(t_.quantity);isNaN(e)||(s=e),a="each"}else a="each";t_.notes&&t.push(t_.notes)}let r=t.length>0?t.join(" â€¢ "):null;try{let{data:t,error:i}=await K.from("job_materials").insert({job_id:ee.id,name:e,checked:!1,notes:r,quantity_decimal:s,unit:a}).select().single();if(i){let e=i?.message||i?.details||i?.hint||JSON.stringify(i)||"Failed to add material";X(e,"error"),console.error("Error adding material:",i);return}ea(e=>[...e,t]),tS({name:"",brand:"",quantity:"",quantityUnit:"gal",color:"",sheen:"",productLine:"",area:"",notes:"",showAdvanced:!1}),eK(!1),eq(""),X("paint"===to?"Paint added!":"Material added!","success")}catch(e){console.error("Error adding material:",e),X(e?.message||e?.details||e?.hint||JSON.stringify(e)||"Failed to add material","error")}}async function tX(e,t){let s=es.find(t=>t.id===e);if(!s)return;let a={checked:t};if(s.inventory_item_id&&s.quantity_decimal&&["in_progress","done"].includes(ee.status)){if(t&&!s.consumed_at){let{data:e,error:t}=await K.from("inventory_items").select("on_hand").eq("id",s.inventory_item_id).single();if(!t&&e){let t=Math.max(0,e.on_hand-(s.quantity_decimal||0));await K.from("inventory_items").update({on_hand:t}).eq("id",s.inventory_item_id),a.consumed_at=new Date().toISOString()}}else if(!t&&s.consumed_at){let{data:e,error:t}=await K.from("inventory_items").select("on_hand").eq("id",s.inventory_item_id).single();if(!t&&e){let t=e.on_hand+(s.quantity_decimal||0);await K.from("inventory_items").update({on_hand:t}).eq("id",s.inventory_item_id),a.consumed_at=null}}}let{error:r}=await K.from("job_materials").update(a).eq("id",e);r?X("Failed to update material","error"):ea(t=>t.map(t=>t.id===e?{...t,...a}:t))}async function tK(e){let{error:t}=await K.from("job_materials").delete().eq("id",e);t?X("Failed to delete material","error"):ea(t=>t.filter(t=>t.id!==e))}async function tY(e,t,s,a){let{error:r}=await K.from("job_materials").update({cost_per_unit:t,quantity_decimal:s,unit:a}).eq("id",e);r?X("Failed to update cost","error"):(ea(r=>r.map(r=>r.id===e?{...r,cost_per_unit:t,quantity_decimal:s,unit:a}:r)),tm(null))}function tZ(){if(0===es.length)return void X("No materials to copy","error");let e=ee.title,t=ee.customer?.name||"Customer",s=`Materials needed for ${e} (${t}):

`;es.forEach((e,t)=>{let a=`${t+1}. ${e.name}`;if(e.notes&&(a+=` - ${e.notes}`),e.quantity_decimal&&e.unit){let t=e.quantity_decimal%1==0?e.quantity_decimal.toFixed(0):e.quantity_decimal;a+=` - ${t} ${e.unit}`}s+=a+`
`}),s+=`
Total items: ${es.length}`,(0,i.copyToClipboard)(s),X("Materials list copied!","success")}function t0(){let e=e7||ee.schedule_token;return e?`${window.location.origin}/s/${e}`:""}function t4(){let e=ee.customer?.name||"there",t=tk?tT&&tT!==tk?`${(0,i.formatDate)(tk)} - ${(0,i.formatDate)(tT)}`:(0,i.formatDate)(tk):"TBD",s=tD?(0,i.formatTime)(tD):"TBD",a=t0();return`Hi ${e}. We're scheduled for ${t}${tD?` at ${s}`:""}. Confirm your appointment here: ${a}`}async function t1(){e8(!0);try{let{data:e,error:t}=await K.from("jobs").insert({company_id:F,customer_id:ee.customer_id,title:`${ee.title} (Copy)`,address1:ee.address1,address2:ee.address2,city:ee.city,state:ee.state,zip:ee.zip,notes:ee.notes,assigned_user_id:ee.assigned_user_id,status:"new"}).select().single();if(t)throw t;if(es.length>0){let t=es.map(t=>({job_id:e.id,name:t.name,notes:t.notes,checked:!1})),{error:s}=await K.from("job_materials").insert(t);s&&(console.error("Error copying materials:",s),X("Job duplicated but materials may not have copied","error"))}X(`Job duplicated! New job ID: ${e.id}`,"success"),(0,i.copyToClipboard)(e.id),e2(!1),V.push(`/app/jobs/${e.id}`)}catch(e){console.error("Error duplicating job:",e),X("Failed to duplicate job","error")}finally{e8(!1)}}return(0,s.useEffect)(()=>{!async function(){let{data:e}=await K.from("pickup_locations").select("id, name").eq("company_id",F).order("name");e&&ed(e)}()},[F]),(0,s.useEffect)(()=>{!async function(){ep(!0);let{data:e}=await K.from("time_entries").select(`
          id,
          user_id,
          started_at,
          ended_at,
          duration_seconds
        `).eq("job_id",ee.id).order("started_at",{ascending:!1});if(e){let t=[...new Set(e.map(e=>e.user_id).filter(e=>null!==e))],s={};if(t.length>0){let{data:e}=await K.from("user_profiles").select("id, full_name").in("id",t);e&&(s=e.reduce((e,t)=>(e[t.id]={full_name:t.full_name||""},e),{}))}eh(e.map(e=>({...e,user:e.user_id?s[e.user_id]:null})))}ep(!1)}()},[ee.id,K,T]),(0,s.useEffect)(()=>{Y&&!eb.userId&&ew(e=>({...e,userId:Y}))},[Y]),(0,s.useEffect)(()=>{!async function(){let{data:e}=await K.from("job_payment_line_items").select("id, title, price").eq("job_id",ee.id).order("sort_order");if(e&&eS(e),"proposed"===ee.payment_state||"approved"===ee.payment_state){let{data:e}=await K.from("estimates").select("id, public_token").eq("job_id",ee.id).maybeSingle();e?.public_token&&0===er.length&&ei([{...er[0]||{},public_token:e.public_token}])}}()},[ee.id,ee.payment_state]),(0,s.useEffect)(()=>{ee.schedule_token&&!e7&&e9(ee.schedule_token)},[ee,e7]),(0,s.useEffect)(()=>{let e=()=>{V.refresh()};return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)},[V]),(0,t.jsxs)("div",{className:"min-h-screen pb-20 lg:pb-0",children:[(0,t.jsx)("div",{className:"border-b bg-card",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto p-4",children:[(0,t.jsxs)("button",{onClick:()=>V.back(),className:"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground mb-4 touch-target",children:[(0,t.jsx)(O.ArrowLeft,{className:"h-4 w-4"}),"Back"]}),(0,t.jsx)("div",{className:"flex flex-col gap-4",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("h1",{className:"text-xl sm:text-2xl font-bold truncate",children:ee.title}),ee.customer&&(0,t.jsxs)("p",{className:"text-muted-foreground flex items-center gap-1 mt-1 text-sm sm:text-base min-w-0",children:[(0,t.jsx)(U.User,{className:"h-4 w-4 shrink-0"}),(0,t.jsx)("span",{className:"truncate",children:ee.customer.name})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,t.jsx)(D.Badge,{className:(0,i.cn)("w-fit text-base px-4 py-2",i.JOB_STATUS_COLORS[ee.status]),children:i.JOB_STATUS_LABELS[ee.status]}),tG(ee.status)&&(0,t.jsx)(c.Button,{variant:"outline",size:"sm",onClick:function(){let e=tG(ee.status);e&&tJ(e)},className:"touch-target min-h-[44px]",title:`Move to ${i.JOB_STATUS_LABELS[tG(ee.status)]}`,children:(0,t.jsx)(W.ChevronRight,{className:"h-4 w-4"})})]})]})})]})}),(0,t.jsx)("div",{className:"max-w-4xl mx-auto p-4",children:(0,t.jsx)("div",{className:"space-y-6",children:(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)("div",{className:"rounded-lg border bg-card p-2.5",children:(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm",children:[tM&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,t.jsx)(A.MapPin,{className:"h-4 w-4 text-muted-foreground shrink-0"}),(0,t.jsx)("span",{children:tM})]}),ee.customer?.phone&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,t.jsx)(H.Phone,{className:"h-4 w-4 text-muted-foreground shrink-0"}),(0,t.jsx)("a",{href:`tel:${ee.customer.phone}`,className:"hover:underline",children:ee.customer.phone})]}),ee.customer?.email&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,t.jsx)(b.Mail,{className:"h-4 w-4 text-muted-foreground shrink-0"}),(0,t.jsx)("a",{href:`mailto:${ee.customer.email}`,className:"hover:underline",children:ee.customer.email})]})]})}),(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)(L,{jobId:ee.id,companyId:F,customerId:ee.customer_id,paymentState:ee.payment_state||"none",paymentAmount:ee.payment_amount||null,paymentApprovedAt:ee.payment_approved_at||null,paymentPaidAt:ee.payment_paid_at||null,paymentMethod:ee.payment_method||null,publicToken:er[0]?.public_token,lineItems:e_,estimatingConfig:$,estimateStatus:er[0]?.status||null,estimateDeniedAt:er[0]?.denied_at||null,estimateDenialReason:er[0]?.denial_reason||null,onUpdate:async()=>{let{data:e}=await K.from("estimates").select("*").eq("job_id",ee.id).order("created_at",{ascending:!1});e&&ei(await Promise.all(e.map(async e=>{let{data:t}=await K.from("estimate_line_items").select("*").eq("estimate_id",e.id);return{...e,line_items:t||[]}})))}}),(0,t.jsxs)("div",{className:"rounded-lg border bg-card p-4 space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Schedule"}),"accepted"===ee.schedule_state&&(0,t.jsxs)(D.Badge,{variant:"success",children:[(0,t.jsx)(n.CheckCircle,{className:"h-3 w-3 mr-1"}),"Confirmed"]}),("proposed"===ee.schedule_state||"awaiting_confirmation"===ee.schedule_state)&&(0,t.jsx)(D.Badge,{variant:"secondary",children:"Awaiting Confirmation"}),"denied"===ee.schedule_state&&(0,t.jsx)(D.Badge,{variant:"destructive",children:"Declined by Customer"})]}),tk&&tD&&!tu&&(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>th(!0),className:"touch-target min-h-[44px]",children:(0,t.jsx)(E.Pencil,{className:"h-4 w-4"})})]}),!tu&&tk&&tD?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"p-3 sm:p-4 rounded-lg bg-muted/30 space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3 min-w-0",children:[(0,t.jsx)(I.Calendar,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary shrink-0 mt-1"}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs sm:text-sm text-muted-foreground",children:tT&&tT!==tk?"Date Range":"Date"}),(0,t.jsx)("p",{className:"font-medium text-sm sm:text-base break-words",children:tT&&tT!==tk?`${(0,i.formatDate)(tk)} - ${(0,i.formatDate)(tT)}`:(0,i.formatDate)(tk)})]})]}),(0,t.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3 min-w-0",children:[(0,t.jsx)(l.Clock,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary shrink-0 mt-1"}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs sm:text-sm text-muted-foreground",children:tT&&tT!==tk?"Daily Arrival Time":"Time"}),(0,t.jsx)("p",{className:"font-medium text-sm sm:text-base",children:(0,i.formatTime)(tD)})]})]})]}),("proposed"===ee.schedule_state||"awaiting_confirmation"===ee.schedule_state)&&(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2",children:[(0,t.jsxs)(c.Button,{variant:"outline",onClick:async()=>{await tO(),e4(!0)},className:"w-full sm:flex-1",children:[(0,t.jsx)(B,{className:"mr-2 h-4 w-4"}),"Share with Customer"]}),(0,t.jsxs)(c.Button,{onClick:tH,className:"w-full sm:flex-1",children:[(0,t.jsx)(n.CheckCircle,{className:"mr-2 h-4 w-4"}),"Mark Confirmed"]})]}),"accepted"===ee.schedule_state&&(0,t.jsx)("div",{className:"p-3 rounded-lg bg-success/10 border border-success/20 text-sm",children:(0,t.jsxs)("p",{className:"flex items-center gap-2 text-success",children:[(0,t.jsx)(n.CheckCircle,{className:"h-4 w-4"}),(0,t.jsxs)("span",{children:["Customer confirmed on ",(0,i.formatDate)(ee.schedule_accepted_at)]})]})}),"denied"===ee.schedule_state&&(0,t.jsxs)("div",{className:"p-3 rounded-lg bg-destructive/10 border border-destructive/20 space-y-2",children:[(0,t.jsxs)("p",{className:"flex items-center gap-2 text-destructive text-sm font-medium",children:[(0,t.jsx)(Q.XCircle,{className:"h-4 w-4"}),"Customer declined this schedule"]}),ee.schedule_denial_reason&&(0,t.jsxs)("p",{className:"text-sm text-muted-foreground pl-6",children:["Reason: ",ee.schedule_denial_reason]}),(0,t.jsxs)(c.Button,{variant:"outline",size:"sm",onClick:()=>th(!0),className:"w-full sm:w-auto",children:[(0,t.jsx)(I.Calendar,{className:"mr-2 h-4 w-4"}),"Propose New Time"]})]}),!ee.schedule_state&&(0,t.jsxs)(c.Button,{variant:"outline",onClick:async()=>{await tO(),e4(!0)},className:"w-full",children:[(0,t.jsx)(B,{className:"mr-2 h-4 w-4"}),"Share with Customer"]})]}):(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)(M,{date:tk||null,time:tD||null,onDateChange:e=>tC(e),onTimeChange:e=>tF(e),label:t$?"Start date and daily arrival time":"Date and time"}),(0,t.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg border bg-muted/30",children:[(0,t.jsx)("input",{type:"checkbox",id:"multiDayToggle",checked:t$,onChange:e=>{tP(e.target.checked),e.target.checked||tq("")},className:"h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-primary cursor-pointer"}),(0,t.jsx)("label",{htmlFor:"multiDayToggle",className:"text-sm font-medium cursor-pointer flex-1",children:"Multi-day job"})]}),t$&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"End date"}),(0,t.jsx)("input",{type:"date",value:tT,onChange:e=>tq(e.target.value),min:tk||void 0,className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[44px]"}),tT&&tT<tk&&(0,t.jsxs)("p",{className:"text-xs text-destructive flex items-center gap-1",children:[(0,t.jsx)("span",{children:"âš ï¸"}),"End date must be after start date"]}),tT&&tT>=tk&&tD&&(0,t.jsx)("div",{className:"p-3 rounded-lg bg-primary/10 border border-primary/20",children:(0,t.jsxs)("p",{className:"text-xs text-foreground flex items-start gap-2",children:[(0,t.jsx)(I.Calendar,{className:"h-4 w-4 text-primary shrink-0 mt-0.5"}),(0,t.jsxs)("span",{children:["Crew will arrive at ",(0,t.jsx)("strong",{children:(0,i.formatTime)(tD)})," each day from ",(0,t.jsx)("strong",{children:(0,i.formatDate)(tk)})," to ",(0,t.jsx)("strong",{children:(0,i.formatDate)(tT)})]})]})})]}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2",children:[tk&&tD&&(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>{th(!1),tC(ee.scheduled_date||""),tq(ee.scheduled_end_date||""),tF(ee.scheduled_time||""),tP(!!ee.scheduled_end_date)},className:"w-full sm:w-auto",children:"Cancel"}),(0,t.jsxs)(c.Button,{onClick:tA,className:"w-full sm:flex-1",children:[(0,t.jsx)(I.Calendar,{className:"mr-2 h-4 w-4"}),tk&&tD&&ee.scheduled_date?"Update Schedule":"Save Schedule"]})]})]})]}),(0,t.jsx)("div",{className:"rounded-lg border bg-card p-4 space-y-6",children:!ty&&es.length>0?(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,t.jsxs)("h3",{className:"font-semibold text-lg",children:["Materials (",es.length,")"]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(c.Button,{variant:"outline",size:"sm",onClick:()=>{tn("materials"),ti(!0)},className:"touch-target min-h-[44px]",children:[(0,t.jsx)(B,{className:"mr-2 h-4 w-4"}),"Share List"]}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tN(!0),className:"touch-target min-h-[44px]",children:(0,t.jsx)(E.Pencil,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[es.slice(0,5).map(e=>(0,t.jsxs)("div",{className:"flex items-start gap-3 p-2 rounded-lg hover:bg-muted/50",children:[(0,t.jsx)(_.SimpleCheckbox,{checked:e.checked,onChange:t=>tX(e.id,t.target.checked),className:"mt-0.5"}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("span",{className:(0,i.cn)("font-medium text-sm",e.checked&&"line-through text-muted-foreground"),children:e.name}),e.notes&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-0.5",children:e.notes}),(e.quantity_decimal||e.unit)&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:[e.quantity_decimal&&`${e.quantity_decimal} `,e.unit||"each"]})]})]},e.id)),es.length>5&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground pt-1 pl-2",children:["+",es.length-5," more"]})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"font-semibold text-lg",children:"Materials"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[es.length>0&&(0,t.jsxs)(c.Button,{variant:"outline",size:"sm",onClick:()=>{tn("materials"),ti(!0)},className:"touch-target min-h-[44px]",children:[(0,t.jsx)(B,{className:"mr-2 h-4 w-4"}),"Share List"]}),ty&&es.length>0&&(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tN(!1),children:(0,t.jsx)(R.X,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("h4",{className:"font-medium text-sm",children:["Checklist (",es.length,")"]}),es.length>0&&(0,t.jsxs)(c.Button,{variant:"outline",size:"sm",onClick:tZ,className:"touch-target min-h-[44px]",children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy List"]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Quick Add"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,t.jsxs)(c.Button,{variant:"outline",size:"sm",onClick:()=>{td("paint"),tS({name:"Paint",brand:"",color:"",sheen:"",quantity:"",quantityUnit:"gal",productLine:"",area:"",notes:"",showAdvanced:!1}),eK(!0)},className:"touch-target min-h-[44px] justify-start",children:[(0,t.jsx)(v.Plus,{className:"mr-2 h-4 w-4"}),"Paint"]}),(0,t.jsxs)(c.Button,{variant:"outline",size:"sm",onClick:()=>{td("generic"),tS({name:"",brand:"",color:"",sheen:"",quantity:"",quantityUnit:"gal",productLine:"",area:"",notes:"",showAdvanced:!1}),eK(!0)},className:"touch-target min-h-[44px] justify-start",children:[(0,t.jsx)(v.Plus,{className:"mr-2 h-4 w-4"}),"Custom"]})]})]}),(0,t.jsx)("div",{className:"rounded-lg border bg-muted/30 divide-y",children:0===es.length?(0,t.jsxs)("div",{className:"p-8 text-center text-muted-foreground",children:[(0,t.jsx)(z.Package,{className:"mx-auto h-8 w-8 mb-2"}),(0,t.jsx)("p",{className:"text-sm",children:"No materials yet"}),(0,t.jsx)("p",{className:"text-xs mt-1",children:"Use Quick Add buttons above"})]}):es.map(e=>(0,t.jsxs)("div",{className:"p-3 space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(_.SimpleCheckbox,{checked:e.checked,onChange:t=>tX(e.id,t.target.checked)}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("span",{className:(0,i.cn)("font-medium",e.checked&&"line-through text-muted-foreground"),children:e.name}),e.notes&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-0.5",children:e.notes})]}),(0,t.jsx)("button",{onClick:()=>tK(e.id),className:"text-muted-foreground hover:text-destructive touch-target min-h-[44px] min-w-[44px] flex items-center justify-center",children:(0,t.jsx)(y.Trash2,{className:"h-4 w-4"})})]}),tc===e.id?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-sm pl-8",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"$"}),(0,t.jsx)(m.Input,{type:"number",step:"0.01",min:"0",placeholder:"0.00",defaultValue:e.cost_per_unit||"",className:"w-20 h-8 text-sm",id:`cost-${e.id}`}),(0,t.jsx)("span",{className:"text-muted-foreground",children:"per"}),(0,t.jsx)(m.Input,{type:"text",placeholder:"unit",defaultValue:e.unit||"each",className:"w-20 h-8 text-sm",id:`unit-${e.id}`}),(0,t.jsx)("span",{className:"text-muted-foreground",children:"Ã—"}),(0,t.jsx)(m.Input,{type:"number",step:"0.01",min:"0",placeholder:"qty",defaultValue:e.quantity_decimal||"",className:"w-16 h-8 text-sm",id:`qty-${e.id}`}),(0,t.jsx)(c.Button,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{let t=document.getElementById(`cost-${e.id}`),s=document.getElementById(`unit-${e.id}`),a=document.getElementById(`qty-${e.id}`);tY(e.id,t.value?parseFloat(t.value):null,a.value?parseFloat(a.value):null,s.value||null)},children:"Save"}),(0,t.jsx)(c.Button,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>tm(null),children:"Cancel"})]}):e.cost_per_unit?(0,t.jsxs)("div",{className:"flex items-center justify-between text-sm pl-8",children:[(0,t.jsxs)("span",{className:"text-muted-foreground",children:[(0,i.formatCurrency)(Math.round(100*e.cost_per_unit))," per ",e.unit||"each",e.quantity_decimal&&` \xd7 ${e.quantity_decimal}`,e.quantity_decimal&&e.cost_per_unit&&(0,t.jsxs)("span",{className:"font-medium ml-2",children:["= ",(0,i.formatCurrency)(Math.round(e.cost_per_unit*e.quantity_decimal*100))]})]}),(0,t.jsx)(c.Button,{size:"sm",variant:"ghost",className:"h-6 text-xs",onClick:()=>tm(e.id),children:"Edit"})]}):(0,t.jsx)("div",{className:"pl-8",children:(0,t.jsx)(c.Button,{size:"sm",variant:"ghost",className:"h-6 text-xs text-muted-foreground",onClick:()=>tm(e.id),children:"+ Add cost"})})]},e.id))}),(()=>{let e=es.filter(e=>e.cost_per_unit&&e.quantity_decimal);if(0===e.length)return null;let s=e.reduce((e,t)=>e+(t.cost_per_unit||0)*(t.quantity_decimal||0),0),a=es.length===e.length,r=el[0];return(0,t.jsxs)("div",{className:"rounded-lg border bg-muted/50 p-3 space-y-2 text-sm",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsxs)("span",{className:"text-muted-foreground",children:["Materials Total",!a&&(0,t.jsx)("span",{className:"text-xs ml-1",children:"(partial)"})]}),(0,t.jsx)("span",{className:"font-medium",children:(0,i.formatCurrency)(Math.round(100*s))})]}),r&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Invoice Total"}),(0,t.jsx)("span",{className:"font-medium",children:(0,i.formatCurrency)(r.amount_total)})]}),(0,t.jsx)("div",{className:"h-px bg-border"}),(0,t.jsxs)("div",{className:"flex justify-between font-semibold",children:[(0,t.jsx)("span",{children:"Estimated Margin"}),(0,t.jsxs)("span",{className:(0,i.cn)(r.amount_total-Math.round(100*s)>0?"text-success":"text-destructive"),children:[(0,i.formatCurrency)(r.amount_total-Math.round(100*s)),(0,t.jsxs)("span",{className:"text-xs ml-1 font-normal",children:["(",Math.round((r.amount_total-Math.round(100*s))/r.amount_total*100),"%)"]})]})]}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"âš ï¸ Materials only - doesn't include labor or overhead"})]})]})})()]})]})}),(0,t.jsx)("div",{className:"rounded-lg border bg-card p-4",children:tx?(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(u.Label,{htmlFor:"assignedUser",className:"text-sm font-medium whitespace-nowrap shrink-0",children:"Who's working on this?"}),(0,t.jsxs)(x.Select,{id:"assignedUser",value:tB,onChange:e=>tE(e.target.value),className:"flex-1 h-9",children:[(0,t.jsx)("option",{value:"",children:"Unassigned"}),T.map(e=>(0,t.jsx)("option",{value:e.id,children:e.fullName},e.id))]}),(0,t.jsx)(c.Button,{onClick:async()=>{await tU(),tp(!1)},className:"shrink-0 h-9",children:"Save"})]}):(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-semibold mb-1",children:"Assign To"}),(0,t.jsx)("div",{className:"text-sm text-muted-foreground",children:tB?(0,t.jsx)("span",{children:T.find(e=>e.id===tB)?.fullName||"Unknown"}):(0,t.jsx)("span",{children:"Unassigned"})})]}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tp(!0),className:"touch-target min-h-[44px]",children:(0,t.jsx)(E.Pencil,{className:"h-4 w-4"})})]})}),(0,t.jsx)("div",{className:"rounded-lg border bg-card p-4 space-y-4",children:!tf&&tL?(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Notes"}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tv(!0),className:"touch-target min-h-[44px]",children:(0,t.jsx)(E.Pencil,{className:"h-4 w-4"})})]}),(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:tL})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Notes"}),tf&&tL&&(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tv(!1),children:(0,t.jsx)(R.X,{className:"h-4 w-4"})})]}),(0,t.jsx)(h.Textarea,{value:tL,onChange:e=>{tI(e.target.value)},placeholder:"Add notes about this job...",rows:4}),(0,t.jsxs)(c.Button,{onClick:tz,className:"w-full",children:[(0,t.jsx)(S,{className:"mr-2 h-4 w-4"}),"Save Notes"]})]})}),(0,t.jsx)("div",{className:"rounded-lg border bg-card p-4 space-y-4",children:!tj&&eu.length>0?(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Time Tracking"}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tg(!0),className:"touch-target min-h-[44px]",children:(0,t.jsx)(E.Pencil,{className:"h-4 w-4"})})]}),(0,t.jsx)("div",{className:"space-y-2",children:Object.entries(eu.reduce((e,t)=>{let s=t.user_id||"unknown",a="unknown"!==s&&(T.find(e=>e.id===s)?.fullName||t.user?.full_name)||"Unknown";e[s]||(e[s]={name:a,totalHours:0,entries:[]});let r=t.duration_seconds?t.duration_seconds/3600:0;return e[s].totalHours+=r,e[s].entries.push(t),e},{})).map(([e,s])=>(0,t.jsxs)("div",{className:"flex items-center justify-between rounded-lg border bg-muted/30 p-2",children:[(0,t.jsx)("span",{className:"text-sm font-medium",children:s.name}),(0,t.jsxs)("span",{className:"text-sm text-muted-foreground",children:[s.totalHours.toFixed(1),"h"]})]},e))})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Time Tracking"}),tj&&eu.length>0&&(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tg(!1),children:(0,t.jsx)(R.X,{className:"h-4 w-4"})})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(u.Label,{className:"text-sm font-medium",children:"Time Logs"}),(0,t.jsxs)(c.Button,{size:"sm",onClick:()=>eN(!0),className:"touch-target min-h-[44px]",children:[(0,t.jsx)(v.Plus,{className:"mr-2 h-4 w-4"}),"Add Hours"]})]}),ex?(0,t.jsx)("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Loading..."}):0===eu.length?(0,t.jsx)("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No time entries yet"}):(0,t.jsx)("div",{className:"space-y-2",children:eu.map(e=>{let s=e.duration_seconds?(e.duration_seconds/3600).toFixed(1):"0",a=new Date(e.started_at).toLocaleDateString([],{month:"short",day:"numeric"}),r=e.user_id&&(T.find(t=>t.id===e.user_id)?.fullName||e.user?.full_name)||"Unknown";return(0,t.jsxs)("div",{className:"flex items-center justify-between rounded-lg border bg-muted/30 p-3",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium",children:r}),(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:[a," â€¢ ",s,"h"]})]}),(0,t.jsx)("div",{className:"flex items-center gap-2",children:ef===e.id?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(m.Input,{type:"number",step:"0.25",min:"0",defaultValue:s,className:"w-20 h-8 text-sm",onBlur:t=>{let s=parseFloat(t.target.value);!isNaN(s)&&s>0?tQ(e.id,s):ev(null)},onKeyDown:t=>{if("Enter"===t.key){let s=parseFloat(t.target.value);!isNaN(s)&&s>0?tQ(e.id,s):ev(null)}else"Escape"===t.key&&ev(null)},autoFocus:!0}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>ev(null),className:"h-8",children:(0,t.jsx)(R.X,{className:"h-3 w-3"})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{onClick:()=>ev(e.id),className:"text-muted-foreground hover:text-foreground",title:"Edit hours",children:(0,t.jsx)(E.Pencil,{className:"h-4 w-4"})}),(0,t.jsx)("button",{onClick:()=>tW(e.id),className:"text-muted-foreground hover:text-destructive",title:"Delete entry",children:(0,t.jsx)(y.Trash2,{className:"h-4 w-4"})})]})})]},e.id)})})]})]})}),(0,t.jsx)("div",{className:"rounded-lg border bg-card p-4 space-y-4",children:tb?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Photos"}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tw(!1),children:(0,t.jsx)(R.X,{className:"h-4 w-4"})})]}),(0,t.jsx)(q,{jobId:ee.id,companyId:F})]}):(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Photos"}),(0,t.jsx)(c.Button,{variant:"ghost",size:"sm",onClick:()=>tw(!0),className:"touch-target min-h-[44px]",children:(0,t.jsx)(E.Pencil,{className:"h-4 w-4"})})]}),(0,t.jsx)(q,{jobId:ee.id,companyId:F,compact:!0})]})}),C.length>0&&(0,t.jsxs)("div",{className:"rounded-lg border bg-card p-4 space-y-4",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"History"}),(0,t.jsx)(o,{history:C})]})]})]})})}),(0,t.jsx)(w,{open:eR,onOpenChange:eQ,companyId:F,job:ee,customer:ee.customer,invoices:el,scheduledDate:tk,scheduledTime:tD,address:tM}),(0,t.jsx)(d.Dialog,{open:!!eW,onOpenChange:e=>!e&&eG(null),children:(0,t.jsxs)(d.DialogContent,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Estimate Details"})}),eW&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(D.Badge,{variant:"accepted"===eW.status?"success":"sent"===eW.status?"secondary":"outline",children:eW.status}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Created ",(0,i.formatDate)(eW.created_at)]})]}),(0,t.jsx)("div",{className:"rounded-lg border divide-y",children:eW.line_items.map(e=>(0,t.jsx)("div",{className:"p-4",children:(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium",children:e.name}),e.description&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-1",children:e.description})]}),(0,t.jsx)("p",{className:"font-medium",children:(0,i.formatCurrency)(e.price)})]})},e.id))}),(0,t.jsx)("div",{className:"p-4 border-t bg-muted/50 rounded-b-lg",children:(0,t.jsxs)("div",{className:"flex items-center justify-between text-lg font-semibold",children:[(0,t.jsx)("span",{children:"Total"}),(0,t.jsx)("span",{children:(0,i.formatCurrency)(eW.line_items.reduce((e,t)=>e+t.price,0))})]})})]})]})}),(0,t.jsx)(d.Dialog,{open:!!eJ,onOpenChange:e=>!e&&eV(null),children:(0,t.jsxs)(d.DialogContent,{className:"max-w-lg",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Invoice Details"})}),eJ&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(D.Badge,{variant:"paid"===eJ.status?"success":"sent"===eJ.status?"secondary":"outline",children:eJ.status}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Created ",(0,i.formatDate)(eJ.created_at)]})]}),(0,t.jsxs)("div",{className:"rounded-lg border bg-card p-6 text-center",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground mb-1",children:"Amount Due"}),(0,t.jsx)("p",{className:"text-4xl font-bold",children:(0,i.formatCurrency)(eJ.amount_total)})]}),"paid"===eJ.status&&eJ.paid_at&&(0,t.jsxs)("div",{className:"bg-success/10 text-success rounded-lg p-4 text-center",children:[(0,t.jsx)("p",{className:"font-semibold",children:"Paid"}),(0,t.jsxs)("p",{className:"text-sm",children:["on ",(0,i.formatDate)(eJ.paid_at)]})]})]})]})}),(0,t.jsx)(d.Dialog,{open:eX,onOpenChange:eK,children:(0,t.jsxs)(d.DialogContent,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"paint"===to?"Add Paint":"Add Material"})}),(0,t.jsxs)("div",{className:"space-y-4",children:["paint"===to?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"paintArea",children:"Area / Use *"}),(0,t.jsxs)(x.Select,{id:"paintArea",value:t_.area,onChange:e=>tS({...t_,area:e.target.value}),className:"min-h-[44px]",children:[(0,t.jsx)("option",{value:"",children:"Select area..."}),(0,t.jsxs)("optgroup",{label:"Interior",children:[(0,t.jsx)("option",{value:"Interior Walls",children:"Interior Walls"}),(0,t.jsx)("option",{value:"Ceiling",children:"Ceiling"}),(0,t.jsx)("option",{value:"Interior Trim",children:"Interior Trim"}),(0,t.jsx)("option",{value:"Doors",children:"Doors"})]}),(0,t.jsxs)("optgroup",{label:"Exterior",children:[(0,t.jsx)("option",{value:"Exterior Walls",children:"Exterior Walls"}),(0,t.jsx)("option",{value:"Exterior Trim",children:"Exterior Trim"}),(0,t.jsx)("option",{value:"Deck/Fence",children:"Deck/Fence"}),(0,t.jsx)("option",{value:"Siding",children:"Siding"})]}),(0,t.jsx)("option",{value:"Other",children:"Other"})]})]}),(0,t.jsxs)("div",{className:"grid gap-4 sm:grid-cols-2",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"paintBrand",children:"Brand (Optional)"}),(0,t.jsxs)(x.Select,{id:"paintBrand",value:t_.brand,onChange:e=>tS({...t_,brand:e.target.value}),className:"min-h-[44px]",children:[(0,t.jsx)("option",{value:"",children:"Select brand..."}),(0,t.jsx)("option",{value:"Sherwin-Williams",children:"Sherwin-Williams"}),(0,t.jsx)("option",{value:"Benjamin Moore",children:"Benjamin Moore"}),(0,t.jsx)("option",{value:"Behr",children:"Behr"}),(0,t.jsx)("option",{value:"PPG",children:"PPG"}),(0,t.jsx)("option",{value:"Other",children:"Other"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"paintColor",children:"Color *"}),(0,t.jsx)(m.Input,{id:"paintColor",value:t_.color,onChange:e=>tS({...t_,color:e.target.value}),placeholder:"e.g., SW 7008 Alabaster",className:"min-h-[44px]"})]})]}),(0,t.jsxs)("div",{className:"grid gap-4 sm:grid-cols-2",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"paintSheen",children:"Sheen *"}),(0,t.jsxs)(x.Select,{id:"paintSheen",value:t_.sheen,onChange:e=>tS({...t_,sheen:e.target.value}),className:"min-h-[44px]",children:[(0,t.jsx)("option",{value:"",children:"Select sheen..."}),(0,t.jsx)("option",{value:"Flat",children:"Flat"}),(0,t.jsx)("option",{value:"Matte",children:"Matte"}),(0,t.jsx)("option",{value:"Eggshell",children:"Eggshell"}),(0,t.jsx)("option",{value:"Satin",children:"Satin"}),(0,t.jsx)("option",{value:"Semi-Gloss",children:"Semi-Gloss"}),(0,t.jsx)("option",{value:"Gloss",children:"Gloss"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"paintQuantity",children:"Quantity"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(m.Input,{id:"paintQuantity",type:"number",min:"0",step:"0.25",value:t_.quantity,onChange:e=>tS({...t_,quantity:e.target.value}),placeholder:"e.g., 3",className:"min-h-[44px] flex-1"}),(0,t.jsxs)(x.Select,{value:t_.quantityUnit,onChange:e=>tS({...t_,quantityUnit:e.target.value}),className:"min-h-[44px] w-28",children:[(0,t.jsx)("option",{value:"gal",children:"Gallons"}),(0,t.jsx)("option",{value:"qt",children:"Quarts"}),(0,t.jsx)("option",{value:"pt",children:"Pints"}),(0,t.jsx)("option",{value:"oz",children:"Oz"})]})]})]})]}),(0,t.jsxs)("button",{type:"button",onClick:()=>tS({...t_,showAdvanced:!t_.showAdvanced}),className:"text-sm text-muted-foreground hover:text-foreground flex items-center gap-1",children:[t_.showAdvanced?"Hide":"Show"," advanced options"]}),t_.showAdvanced&&(0,t.jsxs)("div",{className:"rounded-lg border bg-muted/30 p-4 space-y-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"paintProductLine",children:"Product Line"}),(0,t.jsx)(m.Input,{id:"paintProductLine",value:t_.productLine,onChange:e=>tS({...t_,productLine:e.target.value}),placeholder:"e.g., Duration, Emerald",className:"min-h-[44px]"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"paintNotes",children:"Notes"}),(0,t.jsx)(h.Textarea,{id:"paintNotes",value:t_.notes,onChange:e=>tS({...t_,notes:e.target.value}),placeholder:"e.g., Back wall only, Second coat needed",rows:2})]})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"materialName",children:"Material Name *"}),(0,t.jsx)(m.Input,{id:"materialName",value:t_.name,onChange:e=>tS({...t_,name:e.target.value}),placeholder:"e.g., Roller Set, Tape, Drop Cloth",className:"min-h-[44px]",autoFocus:!0})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"materialQuantity",children:"Quantity"}),(0,t.jsx)(m.Input,{id:"materialQuantity",value:t_.quantity,onChange:e=>tS({...t_,quantity:e.target.value}),placeholder:"e.g., 2 rolls, 1 set, 3 brushes",className:"min-h-[44px]"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"materialNotes",children:"Notes (Optional)"}),(0,t.jsx)(h.Textarea,{id:"materialNotes",value:t_.notes,onChange:e=>tS({...t_,notes:e.target.value}),placeholder:"Any additional details...",rows:2})]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-3 pt-4",children:[(0,t.jsx)(c.Button,{type:"button",variant:"outline",onClick:()=>{eK(!1),tS({name:"",brand:"",quantity:"",quantityUnit:"gal",color:"",sheen:"",productLine:"",area:"",notes:"",showAdvanced:!1})},children:"Cancel"}),(0,t.jsxs)(c.Button,{onClick:tV,disabled:!t_.name.trim()||"paint"===to&&(!t_.color.trim()||!t_.sheen||!t_.area),children:["Add ","paint"===to?"Paint":"Material"]})]})]})]})}),(0,t.jsx)(d.Dialog,{open:e0,onOpenChange:async e=>{e4(e),e&&await tO()},children:(0,t.jsxs)(d.DialogContent,{className:"max-w-lg",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Share Schedule"})}),(0,t.jsx)("div",{className:"space-y-4",children:tk&&tD?te?(0,t.jsx)("div",{className:"text-center py-4",children:(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Generating link..."})}):t0()?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"rounded-lg border bg-card p-4",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground mb-2",children:"Scheduled for"}),(0,t.jsxs)("p",{className:"font-semibold text-lg",children:[tT&&tT!==tk?`${(0,i.formatDate)(tk)} - ${(0,i.formatDate)(tT)}`:(0,i.formatDate)(tk),tD&&` at ${(0,i.formatTime)(tD)}`]})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Schedule Link"}),(0,t.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,t.jsx)(m.Input,{value:t0(),readOnly:!0,className:"font-mono text-sm"}),(0,t.jsx)(c.Button,{variant:"outline",onClick:function(){(0,i.copyToClipboard)(t0()),X("Schedule link copied!","success")},disabled:te,className:"shrink-0",children:(0,t.jsx)(g,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Pre-written Message"}),(0,t.jsx)(h.Textarea,{value:t4(),readOnly:!0,rows:4,className:"mt-2 font-sans"}),(0,t.jsxs)(c.Button,{onClick:function(){(0,i.copyToClipboard)(t4()),X("Schedule message copied!","success")},className:"w-full mt-2",children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy Message"]})]})]})]}):(0,t.jsx)("div",{className:"text-center py-4",children:(0,t.jsx)("p",{className:"text-sm text-destructive",children:"No token available"})}):(0,t.jsxs)("div",{className:"rounded-lg border bg-muted/50 p-4 text-center text-muted-foreground",children:[(0,t.jsx)(I.Calendar,{className:"mx-auto h-8 w-8 mb-2"}),(0,t.jsx)("p",{children:"This job hasn't been scheduled yet."}),(0,t.jsx)("p",{className:"text-sm mt-1",children:"Add a scheduled date and time first."})]})})]})}),(0,t.jsx)(d.Dialog,{open:e1,onOpenChange:e2,children:(0,t.jsxs)(d.DialogContent,{className:"max-w-md",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Duplicate Job?"})}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"This will create a new job with the same customer, address, and materials."}),(0,t.jsxs)("div",{className:"rounded-lg border bg-muted/50 p-3 space-y-2",children:[(0,t.jsx)("p",{className:"text-sm font-medium",children:"Will be copied:"}),(0,t.jsxs)("ul",{className:"text-sm text-muted-foreground space-y-1 list-disc list-inside",children:[(0,t.jsx)("li",{children:"Customer & address"}),(0,t.jsx)("li",{children:"Notes"}),(0,t.jsx)("li",{children:"Assigned team member"}),(0,t.jsxs)("li",{children:["Materials (",es.length," items)"]})]})]}),(0,t.jsxs)("div",{className:"rounded-lg border bg-warning/10 p-3 space-y-2",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-warning",children:"Will NOT be copied:"}),(0,t.jsxs)("ul",{className:"text-sm text-muted-foreground space-y-1 list-disc list-inside",children:[(0,t.jsx)("li",{children:"Schedule (will be unscheduled)"}),(0,t.jsx)("li",{children:'Status (will reset to "new")'}),(0,t.jsx)("li",{children:"Estimates & invoices"})]})]}),(0,t.jsxs)("div",{className:"flex gap-3 justify-end pt-2",children:[(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>e2(!1),disabled:e3,children:"Cancel"}),(0,t.jsxs)(c.Button,{onClick:t1,loading:e3,children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Duplicate"]})]})]})]})}),(0,t.jsx)(k,{open:e5,onOpenChange:e6,mode:ts,jobId:ee.id,companyId:F,onRefresh:()=>V.refresh()}),(0,t.jsx)(d.Dialog,{open:ey,onOpenChange:eN,children:(0,t.jsxs)(d.DialogContent,{className:"max-w-md",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsx)(d.DialogTitle,{children:"Add Hours"})}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"timeWorker",children:"Worker"}),(0,t.jsxs)(x.Select,{id:"timeWorker",value:eb.userId,onChange:e=>ew({...eb,userId:e.target.value}),children:[(0,t.jsx)("option",{value:"",children:"Select worker"}),T.map(e=>(0,t.jsx)("option",{value:e.id,children:e.fullName},e.id))]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"timeDate",children:"Date"}),(0,t.jsx)(m.Input,{id:"timeDate",type:"date",value:eb.date,onChange:e=>ew({...eb,date:e.target.value})})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u.Label,{htmlFor:"timeHours",children:"Hours"}),(0,t.jsx)(m.Input,{id:"timeHours",type:"number",step:"0.25",min:"0",placeholder:"0.0",value:eb.hours,onChange:e=>ew({...eb,hours:e.target.value})})]}),(0,t.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>eN(!1),children:"Cancel"}),(0,t.jsxs)(c.Button,{onClick:async()=>{await tR(),eN(!1),ew({userId:Y,hours:"",date:new Date().toISOString().split("T")[0]})},loading:ej,disabled:!eb.hours||!eb.userId,children:[(0,t.jsx)(v.Plus,{className:"mr-2 h-4 w-4"}),"Add Hours"]})]})]})]})}),(0,t.jsx)(d.Dialog,{open:tr,onOpenChange:ti,children:(0,t.jsxs)(d.DialogContent,{className:"max-w-lg",children:[(0,t.jsx)(d.DialogHeader,{children:(0,t.jsxs)(d.DialogTitle,{children:["estimate"===tl&&"Estimate Message","invoice"===tl&&"Invoice Message","materials"===tl&&"Materials List","reminder"===tl&&"Reminder Message","schedule-confirmation"===tl&&"Schedule Confirmation"]})}),(0,t.jsxs)("div",{className:"space-y-4",children:["estimate"===tl&&er[0]&&(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Estimate Link"}),(0,t.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,t.jsx)(m.Input,{value:`${window.location.origin}/e/${er[0].public_token}`,readOnly:!0,className:"font-mono text-sm"}),(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>{(0,i.copyToClipboard)(`${window.location.origin}/e/${er[0].public_token}`),X("Link copied!","success")},className:"shrink-0",children:(0,t.jsx)(g,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Pre-written Message"}),(0,t.jsx)(h.Textarea,{value:`Hey ${ee.customer?.name||"there"} â€” here's your estimate for ${(0,i.formatCurrency)(er[0].line_items.reduce((e,t)=>e+t.price,0))}: ${window.location.origin}/e/${er[0].public_token}. Let me know if you have any questions!`,readOnly:!0,rows:4,className:"mt-2 font-sans"}),(0,t.jsxs)(c.Button,{onClick:()=>{let e,t,s,a,r;e=ee.customer?.name||"there",s=(t=er[0])?`${window.location.origin}/e/${t.public_token}`:"[estimate link]",a=t?(0,i.formatCurrency)(t.line_items.reduce((e,t)=>e+t.price,0)):"[amount]",r=`Hey ${e} â€” here's your estimate for ${a}: ${s}. Let me know if you have any questions!`,(0,i.copyToClipboard)(r),X("Estimate message copied!","success"),ti(!1)},className:"w-full mt-2",children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy Message"]})]})]}),"invoice"===tl&&el[0]&&(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Invoice Link"}),(0,t.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,t.jsx)(m.Input,{value:`${window.location.origin}/i/${el[0].public_token}`,readOnly:!0,className:"font-mono text-sm"}),(0,t.jsx)(c.Button,{variant:"outline",onClick:()=>{(0,i.copyToClipboard)(`${window.location.origin}/i/${el[0].public_token}`),X("Link copied!","success")},className:"shrink-0",children:(0,t.jsx)(g,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Pre-written Message"}),(0,t.jsx)(h.Textarea,{value:`Hey ${ee.customer?.name||"there"} â€” thanks again for letting us work on your project! Here's your invoice for ${(0,i.formatCurrency)(el[0].amount_total)}: ${window.location.origin}/i/${el[0].public_token}. Let us know if you have any questions!`,readOnly:!0,rows:4,className:"mt-2 font-sans"}),(0,t.jsxs)(c.Button,{onClick:()=>{let e,t,s,a,r;e=ee.customer?.name||"there",s=(t=el[0])?`${window.location.origin}/i/${t.public_token}`:"[invoice link]",a=t?(0,i.formatCurrency)(t.amount_total):"[amount]",r=`Hey ${e} â€” thanks again for letting us work on your project! Here's your invoice for ${a}: ${s}. Let us know if you have any questions!`,(0,i.copyToClipboard)(r),X("Invoice message copied!","success"),ti(!1)},className:"w-full mt-2",children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy Message"]})]})]}),"materials"===tl&&(0,t.jsx)("div",{className:"space-y-3",children:(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Materials List"}),(0,t.jsx)(h.Textarea,{value:(P=ee.title,G=ee.customer?.name||"Customer",J=`Materials needed for ${P} (${G}):

`,es.forEach((e,t)=>{let s=`${t+1}. ${e.name}`;if(e.notes&&(s+=` - ${e.notes}`),e.quantity_decimal&&e.unit){let t=e.quantity_decimal%1==0?e.quantity_decimal.toFixed(0):e.quantity_decimal;s+=` - ${t} ${e.unit}`}J+=s+`
`}),J+=`
Total items: ${es.length}`),readOnly:!0,rows:Math.min(es.length+4,12),className:"mt-2 font-mono text-sm"}),(0,t.jsxs)(c.Button,{onClick:()=>{tZ(),ti(!1)},className:"w-full mt-2",children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy List"]})]})}),"reminder"===tl&&tk&&tD&&(0,t.jsx)("div",{className:"space-y-3",children:(0,t.jsxs)("div",{children:[(0,t.jsx)(u.Label,{className:"text-sm text-muted-foreground",children:"Reminder Message"}),(0,t.jsx)(h.Textarea,{value:`Hey ${ee.customer?.name||"there"} â€” just a reminder that we're scheduled for ${tT&&tT!==tk?`${(0,i.formatDate)(tk)} - ${(0,i.formatDate)(tT)}`:(0,i.formatDate)(tk)} at ${(0,i.formatTime)(tD)} at ${tM||"[address]"}. Reply here if anything changes. See you then!`,readOnly:!0,rows:4,className:"mt-2 font-sans"}),(0,t.jsxs)(c.Button,{onClick:()=>{let e,t,s,a;e=ee.customer?.name||"there",t=tk?tT&&tT!==tk?`${(0,i.formatDate)(tk)} - ${(0,i.formatDate)(tT)}`:(0,i.formatDate)(tk):"[date]",s=tD?(0,i.formatTime)(tD):"[time]",a=`Hey ${e} â€” just a reminder that we're scheduled for ${t} at ${s} at ${tM||"[address]"}. Reply here if anything changes. See you then!`,(0,i.copyToClipboard)(a),X("Reminder message copied!","success"),ti(!1)},className:"w-full mt-2",children:[(0,t.jsx)(g,{className:"mr-2 h-4 w-4"}),"Copy Message"]})]})})]})]})})]})}e.s(["JobDetailView",()=>G],5449)}]);